<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route Finder with Obstacle Avoidance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  <!-- Load Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" crossorigin="anonymous"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Load Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: #f0f0f0;
    }
     
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
     
    .sidebar {
      position: absolute;
      margin: 20px 20px 30px 20px;
      width: 15%;
      min-width: 300px;
      max-height: calc(100vh - 100px);
      top: 0;
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 5px;
      z-index: 1000;
    }
     
    .card {
      font-size: small;
      border-bottom: solid #d3d3d3 2px;
      margin-bottom: 6px;
    }
     
    .card-header {
      font-weight: bold;
      padding: 6px;
    }
     
    .no-route {
      background-color: #d3d3d3;
      color: #f00;
    }
     
    .obstacle-found {
      background-color: #f8d7da;
      color: #721c24;
    }
     
    .route-found {
      background-color: #d4edda;
      color: #155724;
    }
     
    .card-details {
      padding: 3px 6px;
    }

    .control-panel {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .route-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .route-controls input[type="color"] {
      width: 40px;
      height: 30px;
      padding: 0;
      border: none;
    }

    .route-controls input[type="number"] {
      width: 60px;
    }

    .instructions {
      background-color: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-loading {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .status-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .diagnostic-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
    }

    .network-test {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }

    .mapboxgl-popup-content {
      padding: 10px;
      max-width: 200px;
    }
  </style>
</head>
 
<body>
  <div id="map"></div>
  
  <div class="sidebar">
    <div id="status-message" class="status-message status-loading">
      <strong>üîÑ Initializing...</strong><br>
      Starting diagnostic checks...
    </div>

    <div class="instructions">
      <strong>üõ£Ô∏è Route Finder with Obstacle Avoidance</strong><br><br>
      <strong>Features:</strong><br>
      ‚Ä¢ <strong>Manual route planning</strong> with geocoding<br>
      ‚Ä¢ <strong>Click-to-place</strong> waypoints on map<br>
      ‚Ä¢ <strong>Real-time obstacle detection</strong><br>
      ‚Ä¢ <strong>Multiple map styles</strong><br>
      ‚Ä¢ <strong>Visual clearance warnings</strong><br>
      ‚Ä¢ <strong>Route customization</strong><br><br>
      <strong>Usage:</strong><br>
      1. Enter addresses or click map to set points<br>
      2. Choose travel profile (driving/walking/etc.)<br>
      3. Click "Find Route" to analyze<br>
      4. System checks for safety obstacles
    </div>

    <div class="control-panel">
      <div class="input-group">
        <label>üü¢ Starting Point:</label>
        <input type="text" id="origin-input" placeholder="Enter address or click map">
      </div>
      
      <div class="input-group">
        <label>üî¥ Destination:</label>
        <input type="text" id="destination-input" placeholder="Enter address or click map">
      </div>
      
      <div class="input-group">
        <label>üöó Travel Mode:</label>
        <select id="profile-select">
          <option value="driving-traffic">üöó Driving (Traffic)</option>
          <option value="driving">üöô Driving (No Traffic)</option>
          <option value="walking">üö∂ Walking</option>
          <option value="cycling">üö¥ Cycling</option>
        </select>
      </div>
      
      <button id="find-route-btn" onclick="findRoute()">üó∫Ô∏è Find Route</button>
      <button id="clear-route-btn" onclick="clearRoute()">üóëÔ∏è Clear Route</button>
      
      <div class="route-controls">
        <label>Color:</label>
        <input type="color" id="routeColor" value="#ff0000">
        <label>Width:</label>
        <input type="number" id="routeWidth" value="8" min="1" max="20">
      </div>
    </div>

    <div class="control-panel">
      <div class="input-group">
        <label><strong>Map Style:</strong></label>
        <select id="styleSelector">
          <option value="">Loading styles...</option>
        </select>
      </div>
    </div>

    <div class="network-test">
      <strong>üåê Network Diagnostics:</strong>
      <div id="diagnostic-results">Running tests...</div>
    </div>

    <button id="manual-init" onclick="manualInit()">üîÑ Retry Initialization</button>
    <button id="test-different-approach" onclick="testDifferentApproach()">üß™ Try Alternative Loading</button>
    <button onclick="debugMapbox()">üîç Debug Mapbox Status</button>

    <div id="reports"></div>
  </div>

  <script>
    // Global variables
    let map;
    let origin = null;
    let destination = null;
    let isSettingOrigin = true;

    // Your Mapbox access token
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';

    // Obstacle data
    const clearances = {
      type: 'FeatureCollection',
      features: [
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47426, 38.06673] },
          properties: { clearance: "13' 2\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47208, 38.06694] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.60485, 38.12184] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.61905, 37.87504] },
          properties: { clearance: "12' 0\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.55946, 38.30213] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27235, 38.04954] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27264, 37.82917] },
          properties: { clearance: "11' 6\"" }
        }
      ]
    };

    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status-message');
      statusEl.className = 'status-message status-' + type;
      statusEl.innerHTML = message;
    }

    function updateDiagnostics(message) {
      const diagnosticEl = document.getElementById('diagnostic-results');
      diagnosticEl.innerHTML += '<br>‚Ä¢ ' + message;
    }

    async function runNetworkDiagnostics() {
      updateDiagnostics('Testing basic internet connectivity...');
      
      try {
        const response = await fetch('https://httpbin.org/get', { 
          method: 'GET', 
          mode: 'cors',
          headers: { 'Accept': 'application/json' }
        });
        if (response.ok) {
          updateDiagnostics('‚úÖ Internet connection working');
        } else {
          updateDiagnostics('‚ö†Ô∏è Internet connection issues detected');
        }
      } catch (error) {
        updateDiagnostics('‚ùå No internet connection or severe restrictions');
      }

      updateDiagnostics('Testing Mapbox domain access...');
      try {
        const response = await fetch('https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js', { 
          method: 'HEAD',
          mode: 'cors'
        });
        updateDiagnostics('‚úÖ Mapbox domain accessible');
      } catch (error) {
        updateDiagnostics('‚ùå Cannot reach Mapbox domain - trying alternative approach');
      }

      updateDiagnostics('Checking environment restrictions...');
      const userAgent = navigator.userAgent;
      if (window.location.hostname.includes('github.io')) {
        updateDiagnostics('‚ÑπÔ∏è GitHub Pages detected - using HTTPS automatically');
      } else if (window.location.protocol === 'https:') {
        updateDiagnostics('‚úÖ Running over HTTPS');
      } else {
        updateDiagnostics('‚ö†Ô∏è Not running over HTTPS - may cause issues');
      }
    }

    async function testDifferentApproach() {
      updateStatus('<strong>üß™ Trying Alternative Loading...</strong><br>Using different CDN and methods...', 'loading');
      
      const existingScript = document.querySelector('script[src*="mapbox-gl"]');
      if (existingScript) {
        existingScript.remove();
      }
      
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js';
      script.crossOrigin = 'anonymous';
      script.onload = () => {
        updateStatus('<strong>‚úÖ Alternative CDN Success!</strong><br>Mapbox GL loaded from unpkg', 'success');
        manualInit();
      };
      script.onerror = () => {
        updateStatus('<strong>‚ùå Alternative CDN Failed</strong><br>All CDN sources blocked', 'error');
      };
      
      document.head.appendChild(script);
    }

    async function manualInit() {
      try {
        updateStatus('<strong>üó∫Ô∏è Initializing Map...</strong><br>Setting up Mapbox instance...', 'loading');
        
        // Double-check Mapbox GL availability
        if (typeof mapboxgl === 'undefined') {
          throw new Error('Mapbox GL JS library not loaded - trying alternative...');
        }

        updateDiagnostics('‚úÖ Mapbox GL library found');
        updateDiagnostics('Setting access token...');
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        updateDiagnostics('Creating map instance...');
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [-84.5, 38.05],
          zoom: 11,
          preserveDrawingBuffer: true,
          antialias: true
        });

        updateDiagnostics('Waiting for map to load...');

        map.on('load', function() {
          updateStatus('<strong>‚úÖ Map Loaded Successfully!</strong><br>Setting up features...', 'success');
          updateDiagnostics('‚úÖ Map loaded successfully');
          
          try {
            setupMapFeatures();
            populateStyleSelector();
            updateDiagnostics('‚úÖ All features initialized');
            updateStatus('<strong>‚úÖ Ready!</strong><br>Click map or enter addresses to start routing', 'success');
          } catch (setupError) {
            updateDiagnostics('‚ùå Feature setup error: ' + setupError.message);
            updateStatus('<strong>‚ö†Ô∏è Partial Load</strong><br>Map loaded but some features failed', 'error');
          }
        });

        map.on('error', function(e) {
          console.error('Map error:', e);
          const errorMsg = e.error ? e.error.message : 'Unknown map error';
          updateStatus('<strong>‚ùå Map Error:</strong><br>' + errorMsg, 'error');
          updateDiagnostics('‚ùå Map error: ' + errorMsg);
        });

        // Add click handler for setting waypoints
        map.on('click', handleMapClick);

        // Timeout check
        setTimeout(() => {
          if (!map.loaded()) {
            updateStatus('<strong>‚è±Ô∏è Map Loading Timeout</strong><br>Map is taking longer than expected...', 'error');
            updateDiagnostics('‚è±Ô∏è Map load timeout - may still be loading');
          }
        }, 15000);

      } catch (error) {
        console.error('Initialization failed:', error);
        updateStatus('<strong>‚ùå Initialization Failed:</strong><br>' + error.message, 'error');
        updateDiagnostics('‚ùå Init failed: ' + error.message);
        
        // Try alternative loading
        if (error.message.includes('not loaded')) {
          updateDiagnostics('Attempting alternative CDN...');
          testDifferentApproach();
        }
      }
    }

    function setupMapFeatures() {
      try {
        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl());
        
        // Add obstacles
        if (typeof turf !== 'undefined') {
          const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
          
          map.addSource('obstacles', {
            type: 'geojson',
            data: obstacle
          });

          map.addLayer({
            id: 'obstacles-fill',
            type: 'fill',
            source: 'obstacles',
            paint: {
              'fill-color': '#f03b20',
              'fill-opacity': 0.5
            }
          });

          // Add clearance points with popups
          map.addSource('clearance-points', {
            type: 'geojson',
            data: clearances
          });

          map.addLayer({
            id: 'clearance-points',
            type: 'circle',
            source: 'clearance-points',
            paint: {
              'circle-radius': 8,
              'circle-color': '#ff0000',
              'circle-stroke-color': '#ffffff',
              'circle-stroke-width': 2
            }
          });

          // Add popup on click
          map.on('click', 'clearance-points', function(e) {
            new mapboxgl.Popup()
              .setLngLat(e.lngLat)
              .setHTML(`<strong>‚ö†Ô∏è Low Clearance</strong><br>Height: ${e.features[0].properties.clearance}`)
              .addTo(map);
          });

          map.on('mouseenter', 'clearance-points', function() {
            map.getCanvas().style.cursor = 'pointer';
          });

          map.on('mouseleave', 'clearance-points', function() {
            map.getCanvas().style.cursor = '';
          });
        }

        // Setup route layers
        map.addSource('route-line', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });

        map.addLayer({
          id: 'route-line',
          type: 'line',
          source: 'route-line',
          layout: { 'line-join': 'round', 'line-cap': 'round' },
          paint: { 'line-color': '#ff0000', 'line-width': 8, 'line-opacity': 0.8 }
        });

        // Setup markers
        map.addSource('waypoints', {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        });

        map.addLayer({
          id: 'waypoints',
          type: 'circle',
          source: 'waypoints',
          paint: {
            'circle-radius': 10,
            'circle-color': ['get', 'color'],
            'circle-stroke-color': '#ffffff',
            'circle-stroke-width': 3
          }
        });

        // Setup route customization
        setupRouteCustomization();
        
        console.log('‚úÖ Map features setup complete');
        
      } catch (error) {
        console.error('Error in setupMapFeatures:', error);
        updateDiagnostics(`‚ùå Feature setup error: ${error.message}`);
      }
    }

    async function populateStyleSelector() {
      const select = document.getElementById('styleSelector');
      
      try {
        updateDiagnostics('Loading map styles...');
        
        // Clear and set loading state
        select.innerHTML = '<option value="">Loading styles...</option>';
        select.disabled = true;
        
        const defaultStyles = [
          { name: 'üìç Streets', value: 'mapbox://styles/mapbox/streets-v11' },
          { name: 'üå≤ Outdoors', value: 'mapbox://styles/mapbox/outdoors-v11' },
          { name: '‚òÄÔ∏è Light', value: 'mapbox://styles/mapbox/light-v10' },
          { name: 'üåô Dark', value: 'mapbox://styles/mapbox/dark-v10' },
          { name: 'üõ∞Ô∏è Satellite', value: 'mapbox://styles/mapbox/satellite-v9' },
          { name: 'üó∫Ô∏è Satellite Streets', value: 'mapbox://styles/mapbox/satellite-streets-v11' }
        ];
        
        const customStyles = [
        { name: 'Classic Standard', id: 'ckxnnmex53n1b14m07t6sum48' },
        { name: 'Classic Vintage', id: 'ckxnmjiti0rvm14pby8w9si99' },
        { name: 'Dark Digital', id: 'ckxov33jj3le314ueu15gl6yh' },
        { name: 'Dark Monochrome', id: 'ckxmhuc4k2gxm14s0eq1htzns' },
        { name: 'Dark Night Mode', id: 'ckxs1bfov2cay14mnx6nvrzxt' },
        { name: 'Light Engraved', id: 'ckwgtu6ly20cr15qiy9i2ftsz' },
        { name: 'Light High Contrast', id: 'ckxntkwjq4flv14ld7uisp5b1' },
        { name: 'Light Pencil Sketch', id: 'ckxouv50s02lw14r2jiyvnvxh' },
        { name: 'Pastel Blue', id: 'ckxtl08qj2gb215p8y2blzxur' },
        { name: 'Pastel Cool', id: 'ckxtkuk8l10zj14pk8irf7owt' },
        { name: 'Pastel Pink', id: 'ckxtl2a2s0yot14nw9pbn2733' },
        { name: 'Pastel Yellow', id: 'ckxtl35nk4hsb15mry8rwlg4l' },
        { name: 'Satellite Streets', id: 'ckxmjckme2if514s0v3xq4vxy' },
        { name: 'Topography Colorful', id: 'ckxrnuq691z6h14mnuy5jpk5c' },
        { name: 'Topography Globe', id: 'ckxnp39kb5eyw14oaan01mkp0' },
        { name: 'Topography Outdoor', id: 'ckxnkf6rs60r214uc0j42vbj4' },
        { name: 'Topography Subtle', id: 'ckxnqwyww0sri14p9skglgshs' },
        { name: 'Topography Vintage', id: 'ckxno9jbk3nn714s6vjah6fwb' },
        { name: 'Unique Colorful', id: 'ckxrrtfqk0oir15my0y9tpjvj' },
        { name: 'Unique Comic Book 1‚Äô, id: 'ckxovchyg4tfj14s6d7u559tj' },
        { name: 'Unique Comic Book 2', id: 'ckxov6vgm66g214o064dp3vda' },
        { name: 'Unique Dusty Western', id: 'ckxove5sy174l15mq6h82hwxk' },
        { name: 'Unique Picture Book', id: 'ckxoup98z4sv514m0q988ltie' },
        { name: 'Unique Treasure Map', id: 'ckxov1ris0n2415p4e9gn8oxu' },
        { name: 'Unique Woodcut', id: 'ckxous4km02k114m523qh0k9y' },
          // Add your other custom styles here:
          // { name: 'Your Style Name', id: 'your-style-id' },
        ];
        
        // Clear loading message
        select.innerHTML = '';
        
        // Add separator
        const separatorOption = document.createElement('option');
        separatorOption.disabled = true;
        separatorOption.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Default Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
        select.appendChild(separatorOption);
        
        defaultStyles.forEach(style => {
          const option = document.createElement('option');
          option.value = style.value;
          option.textContent = style.name;
          if (style.value === 'mapbox://styles/mapbox/streets-v11') {
            option.selected = true; // Mark current style as selected
          }
          select.appendChild(option);
        });
        
        // Add separator for custom styles
        if (customStyles.length > 0) {
          const customSeparator = document.createElement('option');
          customSeparator.disabled = true;
          customSeparator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Your Custom Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
          select.appendChild(customSeparator);
          
          customStyles.forEach(style => {
            const option = document.createElement('option');
            option.value = `mapbox://styles/cb29/${style.id}`;
            option.textContent = `üé® ${style.name}`;
            select.appendChild(option);
          });
        }
        
        updateDiagnostics(`‚úÖ Loaded ${defaultStyles.length + customStyles.length} map styles`);
        
        // Enable the selector
        select.disabled = false;
        
        // Add change handler
        select.addEventListener('change', function() {
          if (this.value && !this.options[this.selectedIndex].disabled) {
            updateDiagnostics(`Switching to: ${this.options[this.selectedIndex].textContent}`);
            
            // Store current data
            let routeData = null;
            let waypointData = null;
            
            try {
              if (map.getSource('route-line')) {
                routeData = map.getSource('route-line')._data;
              }
              if (map.getSource('waypoints')) {
                waypointData = map.getSource('waypoints')._data;
              }
            } catch (e) {
              // Ignore data retrieval errors
            }
            
            // Change style
            map.setStyle(this.value);
            
            map.once('style.load', function() {
              setTimeout(() => {
                try {
                  setupMapFeatures();
                  
                  // Restore data
                  if (routeData && routeData.features && routeData.features.length > 0) {
                    map.getSource('route-line').setData(routeData);
                  }
                  if (waypointData && waypointData.features && waypointData.features.length > 0) {
                    map.getSource('waypoints').setData(waypointData);
                  }
                  
                  updateDiagnostics(`‚úÖ Style switched successfully`);
                } catch (error) {
                  updateDiagnostics(`‚ö†Ô∏è Style switch error: ${error.message}`);
                }
              }, 200);
            });
            
            map.once('error', function(e) {
              updateDiagnostics(`‚ùå Style error: ${e.error ? e.error.message : 'Unknown error'}`);
            });
          }
        });
        
      } catch (error) {
        console.error('Style selector error:', error);
        updateDiagnostics(`‚ùå Style selector failed: ${error.message}`);
        
        // Fallback to basic selector
        select.innerHTML = '<option value="mapbox://styles/mapbox/streets-v11">üìç Streets (Default)</option>';
        select.disabled = false;
      }
    }

    function setupRouteCustomization() {
      document.getElementById('routeColor').addEventListener('change', function() {
        if (map.getLayer('route-line')) {
          map.setPaintProperty('route-line', 'line-color', this.value);
        }
      });

      document.getElementById('routeWidth').addEventListener('change', function() {
        if (map.getLayer('route-line')) {
          map.setPaintProperty('route-line', 'line-width', parseInt(this.value));
        }
      });
    }

    function handleMapClick(e) {
      const coords = [e.lngLat.lng, e.lngLat.lat];
      
      if (isSettingOrigin) {
        setOrigin(coords);
        isSettingOrigin = false;
      } else {
        setDestination(coords);
        isSettingOrigin = true;
      }
    }

    function setOrigin(coords) {
      origin = coords;
      document.getElementById('origin-input').value = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
      updateWaypoints();
      addReport('üü¢ Origin Set', `Starting point: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`, true);
    }

    function setDestination(coords) {
      destination = coords;
      document.getElementById('destination-input').value = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
      updateWaypoints();
      addReport('üî¥ Destination Set', `End point: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`, true);
    }

    function updateWaypoints() {
      const features = [];
      
      if (origin) {
        features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: origin },
          properties: { color: '#00ff00' }
        });
      }
      
      if (destination) {
        features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: destination },
          properties: { color: '#ff6600' }
        });
      }

      if (map.getSource('waypoints')) {
        map.getSource('waypoints').setData({
          type: 'FeatureCollection',
          features: features
        });
      }
    }

    async function findRoute() {
      if (!origin || !destination) {
        updateStatus('<strong>‚ùå Missing Waypoints</strong><br>Please set both origin and destination', 'error');
        return;
      }

      const profile = document.getElementById('profile-select').value;
      const coords = origin.join(',') + ';' + destination.join(',');
      const url = `https://api.mapbox.com/directions/v5/mapbox/${profile}/${coords}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;

      updateStatus('<strong>üîÑ Finding Route...</strong><br>Analyzing path and obstacles...', 'loading');

      try {
        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          analyzeRoute(data.routes[0]);
        } else {
          updateStatus('<strong>‚ùå No Route Found</strong><br>Try different waypoints or travel mode', 'error');
        }
      } catch (error) {
        updateStatus('<strong>‚ùå Route Error</strong><br>Failed to fetch route: ' + error.message, 'error');
      }
    }

    function analyzeRoute(route) {
      // Display the route
      map.getSource('route-line').setData(route.geometry);

      // Check for obstacles using Turf.js
      const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
      const clear = turf.booleanDisjoint(obstacle, route.geometry);

      const duration = Math.round(route.duration / 60);
      const distance = (route.distance / 1000).toFixed(1);

      if (clear) {
        // Safe route - make it green
        map.setPaintProperty('route-line', 'line-color', '#00ff00');
        addReport('‚úÖ Safe Route Found!', `${duration} min, ${distance} km - avoids all obstacles`, true);
        updateStatus('<strong>‚úÖ Safe Route!</strong><br>' + duration + ' minutes, avoids all obstacles', 'success');
        
        // Apply custom color if user changed it
        const customColor = document.getElementById('routeColor').value;
        if (customColor !== '#ff0000') {
          map.setPaintProperty('route-line', 'line-color', customColor);
        }
      } else {
        // Dangerous route - keep it red and add warning
        map.setPaintProperty('route-line', 'line-color', '#ff0000');
        addReport('‚ö†Ô∏è Obstacle Warning', `${duration} min, ${distance} km - intersects clearance zones`, false);
        updateStatus('<strong>‚ö†Ô∏è Obstacle Warning!</strong><br>Route intersects low-clearance areas', 'error');
      }

      // Apply custom width
      const customWidth = document.getElementById('routeWidth').value;
      map.setPaintProperty('route-line', 'line-width', parseInt(customWidth));

      // Fit map to route
      const bounds = turf.bbox(route.geometry);
      map.fitBounds(bounds, { padding: 50 });
    }

    function clearRoute() {
      origin = null;
      destination = null;
      isSettingOrigin = true;
      
      document.getElementById('origin-input').value = '';
      document.getElementById('destination-input').value = '';
      
      if (map.getSource('route-line')) {
        map.getSource('route-line').setData({ type: 'FeatureCollection', features: [] });
      }
      if (map.getSource('waypoints')) {
        map.getSource('waypoints').setData({ type: 'FeatureCollection', features: [] });
      }
      
      document.getElementById('reports').innerHTML = '';
      updateStatus('<strong>üéØ Ready for New Route</strong><br>Click map or enter addresses to set waypoints', 'loading');
    }

    function addReport(title, details, isSuccess) {
      const reports = document.getElementById('reports');
      const card = document.createElement('div');
      card.className = 'card';
      
      const header = document.createElement('div');
      header.className = `card-header ${isSuccess ? 'route-found' : 'obstacle-found'}`;
      header.textContent = title;
      
      const body = document.createElement('div');
      body.className = 'card-details';
      body.textContent = details;
      
      card.appendChild(header);
      card.appendChild(body);
      reports.insertBefore(card, reports.firstChild);
    }

    // Debug function to check Mapbox status
    function debugMapbox() {
      updateDiagnostics('=== MAPBOX DEBUG INFO ===');
      updateDiagnostics('typeof mapboxgl: ' + typeof mapboxgl);
      
      if (typeof mapboxgl !== 'undefined') {
        updateDiagnostics('Mapbox GL version: ' + (mapboxgl.version || 'unknown'));
        updateDiagnostics('Access token set: ' + (mapboxgl.accessToken ? 'YES' : 'NO'));
        updateDiagnostics('Map instance exists: ' + (map ? 'YES' : 'NO'));
        
        if (map) {
          updateDiagnostics('Map loaded: ' + (map.loaded() ? 'YES' : 'NO'));
          updateDiagnostics('Map style: ' + (map.getStyle() ? 'LOADED' : 'NOT LOADED'));
        }
      } else {
        updateDiagnostics('‚ùå Mapbox GL not found in global scope');
        updateDiagnostics('Available globals: ' + Object.keys(window).filter(k => k.includes('map')).join(', '));
      }
      updateDiagnostics('=== END DEBUG ===');
    }
    window.addEventListener('load', function() {
      console.log('üõ£Ô∏è Route Finder starting...');
      updateStatus('<strong>üîÑ Starting...</strong><br>Checking Mapbox GL availability...', 'loading');
      
      // Check if Mapbox GL is loaded
      if (typeof mapboxgl === 'undefined') {
        updateStatus('<strong>‚ùå Mapbox GL Not Loaded</strong><br>Trying alternative CDN...', 'error');
        testDifferentApproach();
        return;
      }
      
      // Start diagnostics and initialization
      setTimeout(() => {
        runNetworkDiagnostics();
        setTimeout(() => {
          manualInit();
        }, 500);
      }, 500);
    });

    // Immediate check for Mapbox GL
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, checking Mapbox GL...');
      if (typeof mapboxgl !== 'undefined') {
        console.log('‚úÖ Mapbox GL is available');
      } else {
        console.log('‚ùå Mapbox GL not found');
      }
    });

    console.log('üõ£Ô∏è Route Finder script loaded');
  </script>
</body>
</html>
