<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Route Finder - Step 1 Foundation</title>
  
  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  
  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  
  <style>
    /* ===== CSS VARIABLES ===== */
    :root {
      --color-primary: #3b82f6;
      --color-primary-hover: #2563eb;
      --color-primary-light: rgba(59, 130, 246, 0.1);
      
      --color-success: #10b981;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-info: #06b6d4;
      
      --color-text-primary: #1f2937;
      --color-text-secondary: #6b7280;
      --color-text-muted: #9ca3af;
      
      --color-surface-primary: #ffffff;
      --color-surface-secondary: #f9fafb;
      --color-surface-hover: #f3f4f6;
      
      --color-border-light: #e5e7eb;
      --color-border-medium: #d1d5db;
      
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-base: 1rem;
      --font-size-lg: 1.125rem;
      
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      
      --radius-md: 0.375rem;
      --radius-lg: 0.5rem;
      --radius-xl: 0.75rem;
      
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      
      --transition-base: 200ms ease;
      
      --sidebar-width: 380px;
    }

    /* ===== RESET ===== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--color-text-primary);
      background: var(--color-surface-secondary);
      line-height: 1.6;
    }

    /* ===== LAYOUT ===== */
    .app-container {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--color-surface-primary);
      border-right: 1px solid var(--color-border-light);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 100;
      box-shadow: var(--shadow-lg);
      transition: transform var(--transition-base);
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .main-content {
      flex: 1;
      position: relative;
    }

    /* ===== SIDEBAR HEADER ===== */
    .sidebar-header {
      height: 60px;
      background: var(--color-surface-primary);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 var(--space-6);
      position: relative;
    }

    .sidebar-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }

    /* ===== TOGGLE BUTTON ===== */
    .toggle-button {
      position: fixed;
      top: var(--space-4);
      left: calc(var(--sidebar-width) + var(--space-4));
      width: 36px;
      height: 36px;
      background: var(--color-surface-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: var(--shadow-md);
      z-index: 200;
      transition: left var(--transition-base);
    }

    .toggle-button:hover {
      background: var(--color-surface-hover);
    }

    /* When sidebar is hidden, move toggle to left corner */
    .sidebar.hidden ~ .toggle-button {
      left: var(--space-4);
    }

    /* ===== MAP ===== */
    .map-container {
      width: 100%;
      height: 100vh;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* When sidebar is hidden, map should expand to full width without shifting */
    .main-content {
      width: calc(100vw - var(--sidebar-width));
      transition: width var(--transition-base);
    }
    
    .sidebar.hidden ~ .main-content {
      width: 100vw;
    }

    /* ===== SIDEBAR CONTENT ===== */
    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-6);
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }

    /* ===== STATUS MESSAGE ===== */
    .status-message {
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-sm);
      line-height: 1.5;
      display: flex;
      align-items: flex-start;
      gap: var(--space-3);
    }

    .status-loading {
      background: #fef3c7;
      border: 1px solid var(--color-warning);
      color: #92400e;
    }

    .status-success {
      background: #d1fae5;
      border: 1px solid var(--color-success);
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      border: 1px solid var(--color-danger);
      color: #991b1b;
    }

    .status-info {
      background: #dbeafe;
      border: 1px solid var(--color-info);
      color: #1e40af;
    }

    /* ===== CARDS ===== */
    .card {
      background: var(--color-surface-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
    }

    .card-header {
      padding: var(--space-4) var(--space-5);
      background: var(--color-surface-secondary);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: var(--transition-base);
    }

    .card-header:hover {
      background: var(--color-surface-hover);
    }

    .card-header-content {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .card-header h3 {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }

    .card-content {
      padding: var(--space-5);
      max-height: 500px;
      overflow-y: auto;
    }

    .card-content.collapsed {
      display: none;
    }

    /* ===== FORM ELEMENTS ===== */
    .form-group {
      margin-bottom: var(--space-4);
    }

    .form-group:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-primary);
    }

    .form-input, .form-select {
      width: 100%;
      padding: var(--space-3);
      border: 1px solid var(--color-border-medium);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      background: var(--color-surface-primary);
      color: var(--color-text-primary);
      transition: var(--transition-base);
    }

    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    .form-input::placeholder {
      color: var(--color-text-muted);
    }

    /* ===== BUTTONS ===== */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      text-decoration: none;
      cursor: pointer;
      transition: var(--transition-base);
      min-height: 36px;
    }

    .btn-primary {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }

    .btn-primary:hover {
      background: var(--color-primary-hover);
      border-color: var(--color-primary-hover);
    }

    .btn-secondary {
      background: var(--color-surface-primary);
      color: var(--color-text-primary);
      border-color: var(--color-border-medium);
    }

    .btn-secondary:hover {
      background: var(--color-surface-hover);
    }

    .btn-danger {
      background: var(--color-danger);
      color: white;
      border-color: var(--color-danger);
    }

    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-full {
      width: 100%;
    }

    .button-group {
      display: flex;
      gap: var(--space-2);
    }

    .button-group .btn {
      flex: 1;
    }

    /* ===== ROUTE STATS ===== */
    .route-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border-light);
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
    }

    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ===== WAYPOINTS LIST ===== */
    .waypoints-list {
      margin-top: var(--space-4);
    }

    .waypoint-item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-surface-secondary);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
    }

    .waypoint-item:last-child {
      margin-bottom: 0;
    }

    .waypoint-marker {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--color-success);
      flex-shrink: 0;
    }

    .waypoint-text {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .waypoint-remove {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: var(--space-1);
      border-radius: var(--radius-md);
      transition: var(--transition-base);
    }

    .waypoint-remove:hover {
      color: var(--color-danger);
      background: var(--color-surface-hover);
    }

    /* ===== CROSSHAIR ===== */
    .crosshair-center {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 2px;
      height: 2px;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 10;
    }

    .crosshair-center::before,
    .crosshair-center::after {
      content: '';
      position: absolute;
      background: var(--color-primary);
    }

    .crosshair-center::before {
      width: 2px;
      height: 40px;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
    }

    .crosshair-center::after {
      width: 40px;
      height: 2px;
      top: 50%;
      left: -20px;
      transform: translateY(-50%);
    }

    /* ===== ANIMATIONS ===== */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* ===== COLOR PICKER & WEIGHT CONTROLS ===== */
    .appearance-controls {
      display: flex;
      align-items: center;
      gap: var(--space-6);
      background: var(--color-surface-secondary);
      border: 1px solid var(--color-border-medium);
      border-radius: var(--radius-md);
      padding: var(--space-3);
    }

    .color-section,
    .weight-section {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .control-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      min-width: 40px;
    }

    .color-picker {
      width: 50px;
      height: 32px;
      border: 1px solid var(--color-border-medium);
      border-radius: var(--radius-md);
      cursor: pointer;
      background: none;
    }

    .color-picker::-webkit-color-swatch-wrapper {
      padding: 2px;
      border: none;
      border-radius: var(--radius-md);
    }

    .color-picker::-webkit-color-swatch {
      border: none;
      border-radius: calc(var(--radius-md) - 2px);
    }

    .weight-control {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      background: var(--color-surface-primary);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      padding: var(--space-1);
    }

    .btn-weight {
      background: none;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: calc(var(--radius-md) - 1px);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--color-text-secondary);
      transition: var(--transition-base);
    }

    .btn-weight:hover {
      background: var(--color-surface-hover);
      color: var(--color-text-primary);
    }

    .weight-display {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-primary);
      min-width: 30px;
      text-align: center;
    }
    @media (max-width: 768px) {
      :root {
        --sidebar-width: 320px;
      }
      
      .sidebar-content {
        padding: var(--space-4);
      }
      
      .card-content {
        padding: var(--space-4);
      }
      
      .route-stats {
        grid-template-columns: 1fr;
        gap: var(--space-2);
      }
    }
  </style>
</head>

<body>
  <div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <!-- Sidebar Header -->
      <div class="sidebar-header">
        <div class="sidebar-title">Route Finder</div>
      </div>
      
      <!-- Sidebar Content -->
      <div class="sidebar-content">
        <!-- Status Message -->
        <div id="status-message" class="status-message status-loading">
          <i data-feather="loader" class="pulse"></i>
          <div>
            <strong>Initializing Route Finder...</strong><br>
            Loading mapping services
          </div>
        </div>

        <!-- Route Planning Card -->
        <div class="card">
          <div class="card-header" onclick="toggleSection('route-planning')">
            <div class="card-header-content">
              <i data-feather="map"></i>
              <h3>Route Planning</h3>
            </div>
            <i data-feather="chevron-down" id="route-planning-chevron"></i>
          </div>
          <div class="card-content" id="route-planning-content">
            <!-- Origin -->
            <div class="form-group">
              <label class="form-label">
                <i data-feather="map-pin" style="color: var(--color-danger);"></i>
                Origin
              </label>
              <input type="text" id="origin-input" class="form-input" placeholder="Enter starting location or click map">
            </div>

            <!-- Destination -->
            <div class="form-group">
              <label class="form-label">
                <i data-feather="flag" style="color: var(--color-primary);"></i>
                Destination
              </label>
              <input type="text" id="destination-input" class="form-input" placeholder="Enter destination or click map">
            </div>

            <!-- Travel Mode -->
            <div class="form-group">
              <label class="form-label">
                <i data-feather="navigation"></i>
                Travel Mode
              </label>
              <select id="travel-mode" class="form-select">
                <option value="driving">Driving</option>
                <option value="walking">Walking</option>
                <option value="cycling">Cycling</option>
              </select>
            </div>

            <!-- Route Appearance -->
            <div class="form-group">
              <label class="form-label">
                <i data-feather="navigation-2"></i>
                Route Appearance
              </label>
              <div class="appearance-controls">
                <div class="color-section">
                  <span class="control-label">Color</span>
                  <input type="color" id="route-color" class="color-picker" value="#3b82f6" onchange="updateRouteColor()">
                </div>
                <div class="weight-section">
                  <span class="control-label">Weight</span>
                  <div class="weight-control">
                    <button class="btn-weight" onclick="decreaseLineWeight()">
                      <i data-feather="chevron-down"></i>
                    </button>
                    <span class="weight-display" id="weight-display">4px</span>
                    <button class="btn-weight" onclick="increaseLineWeight()">
                      <i data-feather="chevron-up"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Route Controls -->
            <div class="button-group">
              <button class="btn btn-secondary" onclick="toggleWaypointMode()">
                <i data-feather="plus-circle"></i>
                Add Stop
              </button>
              <button class="btn btn-primary" onclick="calculateRoute()">
                <i data-feather="navigation"></i>
                Get Route
              </button>
            </div>

            <!-- Waypoints List -->
            <div id="waypoints-container" style="display: none;">
              <label class="form-label">
                <i data-feather="more-horizontal" style="color: var(--color-success);"></i>
                Stops Along Route
              </label>
              <div class="waypoints-list" id="waypoints-list"></div>
            </div>
          </div>
        </div>

        <!-- Map Controls Card -->
        <div class="card">
          <div class="card-header" onclick="toggleSection('map-controls')">
            <div class="card-header-content">
              <i data-feather="settings"></i>
              <h3>Map Controls</h3>
            </div>
            <i data-feather="chevron-down" id="map-controls-chevron"></i>
          </div>
          <div class="card-content" id="map-controls-content">
            <!-- Map Style -->
            <div class="form-group">
              <label class="form-label">
                <i data-feather="layers"></i>
                Map Style
              </label>
              <select id="map-style" class="form-select" onchange="changeMapStyle()">
                <optgroup label="Standard Styles">
                  <option value="streets-v12">Streets</option>
                  <option value="outdoors-v12">Outdoors</option>
                  <option value="light-v11">Light</option>
                  <option value="dark-v11">Dark</option>
                  <option value="satellite-v9">Satellite</option>
                  <option value="satellite-streets-v12">Satellite Streets</option>
                </optgroup>
                <optgroup label="Navigation Styles">
                  <option value="navigation-day-v1">Navigation Day</option>
                  <option value="navigation-night-v1">Navigation Night</option>
                </optgroup>
              </select>
            </div>

            <!-- View Controls -->
            <div class="button-group">
              <button class="btn btn-secondary" onclick="zoomToRoute()">
                <i data-feather="zoom-in"></i>
                Fit Route
              </button>
              <button class="btn btn-secondary" onclick="resetView()">
                <i data-feather="home"></i>
                Reset View
              </button>
            </div>

            <!-- Map Navigation -->
            <div class="button-group" style="margin-top: var(--space-4);">
              <button class="btn btn-secondary" onclick="zoomIn()">
                <i data-feather="plus"></i>
                Zoom In
              </button>
              <button class="btn btn-secondary" onclick="zoomOut()">
                <i data-feather="minus"></i>
                Zoom Out
              </button>
            </div>

            <!-- Route Management -->
            <div class="button-group" style="margin-top: var(--space-4);">
              <button class="btn btn-danger" onclick="clearRoute()">
                <i data-feather="x-circle"></i>
                Clear Route
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toggle Button -->
    <button class="toggle-button" onclick="toggleSidebar()" id="toggle-button">
      <i data-feather="sidebar" id="toggle-icon"></i>
    </button>

    <!-- Main Content -->
    <div class="main-content">
      <div class="map-container">
        <div id="map"></div>
        <div id="crosshair" class="crosshair-center" style="display: none;"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURATION =====
    const CONFIG = {
      mapbox: {
        accessToken: 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw',
        defaultCenter: [-74.0060, 40.7128], // New York City
        defaultZoom: 11,
        style: 'mapbox://styles/mapbox/streets-v12'
      },
      routing: {
        baseUrl: 'https://api.mapbox.com/directions/v5/mapbox'
      }
    };

    // ===== APPLICATION STATE =====
    const State = {
      map: null,
      route: {
        origin: null,
        destination: null,
        waypoints: [],
        geometry: null,
        distance: null,
        color: '#3b82f6',
        width: 4
      },
      ui: {
        sidebarVisible: true,
        addingWaypoint: false,
        collapsedSections: new Set()
      },
      markers: {
        origin: null,
        destination: null,
        waypoints: []
      }
    };

    // ===== UTILITY FUNCTIONS =====
    function updateStatus(message, type = 'info', icon = 'info') {
      const statusEl = document.getElementById('status-message');
      if (!statusEl) {
        console.error('Status element not found');
        return;
      }
      
      // Update the entire status message content
      statusEl.className = `status-message status-${type}`;
      statusEl.innerHTML = `
        <i data-feather="${icon}"></i>
        <div>${message}</div>
      `;
      
      // Replace feather icons
      feather.replace();
    }

    function formatDistance(meters) {
      if (meters < 1000) {
        return `${Math.round(meters)} m`;
      } else if (meters < 100000) {
        return `${(meters / 1000).toFixed(1)} km`;
      } else {
        return `${Math.round(meters / 1000)} km`;
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ===== MAP INITIALIZATION =====
    function initializeMap() {
      try {
        console.log('Initializing map with token:', CONFIG.mapbox.accessToken.substring(0, 20) + '...');
        mapboxgl.accessToken = CONFIG.mapbox.accessToken;
        
        State.map = new mapboxgl.Map({
          container: 'map',
          style: CONFIG.mapbox.style,
          center: CONFIG.mapbox.defaultCenter,
          zoom: CONFIG.mapbox.defaultZoom,
          preserveDrawingBuffer: true // For high-res export in Step 3
        });

        // Remove default navigation control since we'll add our own
        // State.map.addControl(new mapboxgl.NavigationControl(), 'top-right');
        
        State.map.on('load', onMapLoad);
        State.map.on('click', onMapClick);
        State.map.on('error', function(e) {
          console.error('Map error:', e);
          updateStatus('<strong>Map Error</strong><br>Failed to load map', 'error', 'alert-triangle');
        });
        
        console.log('Map initialization started...');
        updateStatus('<strong>Loading Map</strong><br>Initializing mapping services...', 'loading', 'loader');
        
      } catch (error) {
        console.error('Map initialization error:', error);
        updateStatus('<strong>Initialization Error</strong><br>Failed to start map', 'error', 'alert-triangle');
      }
    }

    function onMapLoad() {
      console.log('Map loaded successfully');
      
      // Add source for route line
      State.map.addSource('route', {
        type: 'geojson',
        data: {
          type: 'Feature',
          properties: {},
          geometry: {
            type: 'LineString',
            coordinates: []
          }
        }
      });

      // Add route line layer
      State.map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route',
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': State.route.color,
          'line-width': State.route.width
        }
      });

      updateStatus('<strong>Ready to Route</strong><br>Click map or enter addresses', 'info', 'map-pin');
    }

    function onMapClick(e) {
      const coords = [e.lngLat.lng, e.lngLat.lat];
      console.log('Map clicked at:', coords);
      
      if (State.ui.addingWaypoint) {
        console.log('Adding waypoint mode');
        addWaypointAt(coords);
        State.ui.addingWaypoint = false;
        document.body.style.cursor = 'default';
        updateStatus('<strong>Waypoint Added</strong><br>Click "Get Route" to update path', 'success', 'check-circle');
      } else if (!State.route.origin) {
        console.log('Setting origin');
        setOrigin(coords);
      } else if (!State.route.destination) {
        console.log('Setting destination');
        setDestination(coords);
      } else {
        console.log('Both origin and destination already set');
        updateStatus('<strong>Route Complete</strong><br>Click "Add Stop" for waypoints or "Get Route"', 'info', 'info');
      }
    }

    // ===== ROUTE PLANNING =====
    function setOrigin(coords) {
      State.route.origin = coords;
      console.log('Origin set to:', coords);
      updateMarkers();
      updateInputFromCoords('origin-input', coords);
      updateStatus('<strong>Origin Set</strong><br>Now click for destination', 'success', 'map-pin');
    }

    function setDestination(coords) {
      State.route.destination = coords;
      console.log('Destination set to:', coords);
      updateMarkers();
      updateInputFromCoords('destination-input', coords);
      updateStatus('<strong>Destination Set</strong><br>Click "Get Route" to calculate', 'success', 'flag');
    }

    function addWaypointAt(coords) {
      State.route.waypoints.push(coords);
      updateMarkers();
      updateWaypointsList();
      updateStatus('<strong>Waypoint Added</strong><br>Click "Get Route" to calculate path', 'success', 'plus-circle');
    }

    function toggleWaypointMode() {
      State.ui.addingWaypoint = !State.ui.addingWaypoint;
      
      if (State.ui.addingWaypoint) {
        updateStatus('<strong>Adding Waypoint</strong><br>Click map to add a stop', 'info', 'plus-circle');
        document.body.style.cursor = 'crosshair';
      } else {
        updateStatus('<strong>Waypoint Mode Off</strong><br>Normal map interaction', 'info', 'mouse-pointer');
        document.body.style.cursor = 'default';
      }
    }

    function removeWaypoint(index) {
      State.route.waypoints.splice(index, 1);
      updateMarkers();
      updateWaypointsList();
      updateStatus('<strong>Waypoint Removed</strong><br>Click "Get Route" to update path', 'success', 'trash-2');
      if (State.route.geometry) {
        calculateRoute(); // Recalculate if route exists
      }
    }

    async function calculateRoute() {
      if (!State.route.origin || !State.route.destination) {
        updateStatus('<strong>Missing Points</strong><br>Set origin and destination first', 'error', 'alert-circle');
        return;
      }

      try {
        updateStatus('<strong>Calculating Route</strong><br>Finding best path...', 'loading', 'loader');

        const travelMode = document.getElementById('travel-mode').value;
        const coordinates = [
          State.route.origin,
          ...State.route.waypoints,
          State.route.destination
        ];

        const coordsString = coordinates.map(coord => coord.join(',')).join(';');
        const url = `${CONFIG.routing.baseUrl}/${travelMode}/${coordsString}?geometries=geojson&access_token=${CONFIG.mapbox.accessToken}`;

        const response = await fetch(url);
        const data = await response.json();

        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          State.route.geometry = route.geometry;
          State.route.distance = route.distance;

          // Update map
          State.map.getSource('route').setData({
            type: 'Feature',
            properties: {},
            geometry: route.geometry
          });

          updateRouteStats();
          zoomToRoute();
          updateStatus('<strong>Route Calculated</strong><br>Path found successfully', 'success', 'check-circle');
        } else {
          throw new Error('No route found');
        }
      } catch (error) {
        console.error('Route calculation error:', error);
        updateStatus('<strong>Route Error</strong><br>Could not calculate route', 'error', 'alert-triangle');
      }
    }

    // ===== UI UPDATES =====
    function updateMarkers() {
      // Clear existing markers
      if (State.markers.origin) State.markers.origin.remove();
      if (State.markers.destination) State.markers.destination.remove();
      State.markers.waypoints.forEach(marker => marker.remove());
      State.markers.waypoints = [];

      // Add origin marker
      if (State.route.origin) {
        const el = document.createElement('div');
        el.style.width = '12px';
        el.style.height = '12px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = '#ef4444';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        
        State.markers.origin = new mapboxgl.Marker(el)
          .setLngLat(State.route.origin)
          .addTo(State.map);
      }

      // Add destination marker
      if (State.route.destination) {
        const el = document.createElement('div');
        el.style.width = '12px';
        el.style.height = '12px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = '#3b82f6';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        
        State.markers.destination = new mapboxgl.Marker(el)
          .setLngLat(State.route.destination)
          .addTo(State.map);
      }

      // Add waypoint markers
      State.route.waypoints.forEach(waypoint => {
        const el = document.createElement('div');
        el.style.width = '10px';
        el.style.height = '10px';
        el.style.borderRadius = '50%';
        el.style.backgroundColor = '#10b981';
        el.style.border = '2px solid white';
        el.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
        
        const marker = new mapboxgl.Marker(el)
          .setLngLat(waypoint)
          .addTo(State.map);
        
        State.markers.waypoints.push(marker);
      });
    }

    function updateWaypointsList() {
      const container = document.getElementById('waypoints-container');
      const list = document.getElementById('waypoints-list');
      
      if (State.route.waypoints.length === 0) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      list.innerHTML = '';

      State.route.waypoints.forEach((waypoint, index) => {
        const item = document.createElement('div');
        item.className = 'waypoint-item';
        
        item.innerHTML = `
          <div class="waypoint-marker"></div>
          <div class="waypoint-text">Stop ${index + 1}: ${waypoint[1].toFixed(4)}, ${waypoint[0].toFixed(4)}</div>
          <button class="waypoint-remove" onclick="removeWaypoint(${index})" title="Remove waypoint">
            <i data-feather="x" style="width: 14px; height: 14px;"></i>
          </button>
        `;
        
        list.appendChild(item);
      });
      
      feather.replace();
    }

    function updateRouteStats() {
      const statsEl = document.getElementById('route-stats');
      const distanceEl = document.getElementById('route-distance');
      const pointsEl = document.getElementById('route-points');
      
      if (State.route.distance !== null) {
        statsEl.style.display = 'grid';
        distanceEl.textContent = formatDistance(State.route.distance);
        pointsEl.textContent = 1 + State.route.waypoints.length + 1; // origin + waypoints + destination
      } else {
        statsEl.style.display = 'none';
      }
    }

    async function updateInputFromCoords(inputId, coords) {
      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${coords[0]},${coords[1]}.json?access_token=${CONFIG.mapbox.accessToken}`
        );
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          document.getElementById(inputId).value = data.features[0].place_name;
        }
      } catch (error) {
        console.error('Geocoding error:', error);
        document.getElementById(inputId).value = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
      }
    }

    // ===== ADDRESS SEARCH =====
    async function searchAddress(query, callback) {
      if (!query || query.length < 3) return;
      
      try {
        const response = await fetch(
          `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${CONFIG.mapbox.accessToken}&limit=5`
        );
        const data = await response.json();
        
        if (data.features && data.features.length > 0) {
          callback(data.features[0].center);
        }
      } catch (error) {
        console.error('Address search error:', error);
      }
    }

    // ===== MAP CONTROLS =====
    function changeMapStyle() {
      const style = document.getElementById('map-style').value;
      console.log('Changing map style to:', style);
      
      State.map.setStyle(`mapbox://styles/mapbox/${style}`);
      
      // Re-add route layer after style change
      State.map.once('styledata', function() {
        console.log('Style data loaded, re-adding route layer');
        // Wait for style to be fully loaded
        setTimeout(() => {
          if (State.map.isStyleLoaded()) {
            addRouteLayer();
            // Update route appearance with current settings
            updateRouteAppearance();
          }
        }, 200);
      });
    }

    // ===== ROUTE APPEARANCE CONTROLS =====
    function updateRouteColor() {
      const color = document.getElementById('route-color').value;
      setRouteColor(color);
    }

    function setRouteColor(color) {
      State.route.color = color;
      document.getElementById('route-color').value = color;
      updateRouteAppearance();
    }

    function increaseLineWeight() {
      if (State.route.width < 20) {
        State.route.width += 1;
        updateWeightDisplay();
        updateRouteAppearance();
      }
    }

    function decreaseLineWeight() {
      if (State.route.width > 1) {
        State.route.width -= 1;
        updateWeightDisplay();
        updateRouteAppearance();
      }
    }

    function updateWeightDisplay() {
      document.getElementById('weight-display').textContent = State.route.width + 'px';
    }

    function updateRouteAppearance() {
      if (State.map.getLayer('route-line')) {
        State.map.setPaintProperty('route-line', 'line-color', State.route.color);
        State.map.setPaintProperty('route-line', 'line-width', State.route.width);
      }
    }

    function addRouteLayer() {
      console.log('Adding route layer to map');
      
      if (!State.map.getSource('route')) {
        console.log('Creating new route source');
        State.map.addSource('route', {
          type: 'geojson',
          data: {
            type: 'Feature',
            properties: {},
            geometry: State.route.geometry || {
              type: 'LineString',
              coordinates: []
            }
          }
        });
      }

      if (!State.map.getLayer('route-line')) {
        console.log('Creating new route layer');
        State.map.addLayer({
          id: 'route-line',
          type: 'line',
          source: 'route',
          layout: {
            'line-join': 'round',
            'line-cap': 'round'
          },
          paint: {
            'line-color': State.route.color,
            'line-width': State.route.width
          }
        });
      }
      
      // Update data if we have route geometry
      if (State.route.geometry) {
        console.log('Updating route data');
        State.map.getSource('route').setData({
          type: 'Feature',
          properties: {},
          geometry: State.route.geometry
        });
      }
    }

    function clearRoute() {
      // Clear route data
      State.route.origin = null;
      State.route.destination = null;
      State.route.waypoints = [];
      State.route.geometry = null;
      State.route.distance = null;
      
      // Clear form inputs
      document.getElementById('origin-input').value = '';
      document.getElementById('destination-input').value = '';
      
      // Clear map
      if (State.map.getSource('route')) {
        State.map.getSource('route').setData({
          type: 'Feature',
          properties: {},
          geometry: {
            type: 'LineString',
            coordinates: []
          }
        });
      }
      
      updateMarkers();
      updateWaypointsList();
      updateStatus('<strong>Route Cleared</strong><br>Ready for new route', 'success', 'trash-2');
    }

    function zoomToRoute() {
      const points = [];
      
      if (State.route.origin) points.push(State.route.origin);
      if (State.route.destination) points.push(State.route.destination);
      points.push(...State.route.waypoints);
      
      if (points.length === 0) {
        updateStatus('<strong>No Route Points</strong><br>Add origin and destination first', 'error', 'alert-triangle');
        return;
      }
      
      if (points.length === 1) {
        State.map.flyTo({
          center: points[0],
          zoom: 14
        });
      } else {
        const bounds = new mapboxgl.LngLatBounds();
        points.forEach(point => bounds.extend(point));
        State.map.fitBounds(bounds, { padding: 50 });
      }
      
      updateStatus('<strong>View Adjusted</strong><br>Showing route points', 'success', 'maximize-2');
    }

    function resetView() {
      State.map.flyTo({
        center: CONFIG.mapbox.defaultCenter,
        zoom: CONFIG.mapbox.defaultZoom
      });
      updateStatus('<strong>View Reset</strong><br>Returned to New York City', 'success', 'home');
    }

    function zoomIn() {
      State.map.zoomIn();
      updateStatus('<strong>Zoomed In</strong><br>Map view enlarged', 'success', 'plus');
    }

    function zoomOut() {
      State.map.zoomOut();
      updateStatus('<strong>Zoomed Out</strong><br>Map view reduced', 'success', 'minus');
    }

    // ===== UI SECTION MANAGEMENT =====
    function toggleSection(sectionId) {
      const content = document.getElementById(`${sectionId}-content`);
      const chevron = document.getElementById(`${sectionId}-chevron`);
      
      if (State.ui.collapsedSections.has(sectionId)) {
        // Expand
        content.classList.remove('collapsed');
        chevron.setAttribute('data-feather', 'chevron-down');
        State.ui.collapsedSections.delete(sectionId);
      } else {
        // Collapse
        content.classList.add('collapsed');
        chevron.setAttribute('data-feather', 'chevron-right');
        State.ui.collapsedSections.add(sectionId);
      }
      
      feather.replace();
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggleIcon = document.getElementById('toggle-icon');
      
      State.ui.sidebarVisible = !State.ui.sidebarVisible;
      
      if (State.ui.sidebarVisible) {
        sidebar.classList.remove('hidden');
        toggleIcon.setAttribute('data-feather', 'x');
      } else {
        sidebar.classList.add('hidden');
        toggleIcon.setAttribute('data-feather', 'menu');
      }
      
      feather.replace();
    }

    // ===== ADDRESS INPUT HANDLERS =====
    const debouncedOriginSearch = debounce(function(query) {
      searchAddress(query, function(coords) {
        State.route.origin = coords;
        updateMarkers();
      });
    }, 500);

    const debouncedDestinationSearch = debounce(function(query) {
      searchAddress(query, function(coords) {
        State.route.destination = coords;
        updateMarkers();
      });
    }, 500);

    // ===== KEYBOARD SHORTCUTS =====
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        clearRoute();
      }
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        updateStatus('<strong>Save Prepared</strong><br>Export functionality coming in Step 3', 'info', 'save');
      }
    });

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize map
      initializeMap();
      
      // Setup address input handlers
      const originInput = document.getElementById('origin-input');
      const destinationInput = document.getElementById('destination-input');
      
      originInput.addEventListener('input', function() {
        if (this.value.length > 2) {
          debouncedOriginSearch(this.value);
        }
      });
      
      destinationInput.addEventListener('input', function() {
        if (this.value.length > 2) {
          debouncedDestinationSearch(this.value);
        }
      });
      
      // Handle enter key in inputs
      originInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchAddress(this.value, function(coords) {
            State.route.origin = coords;
            updateMarkers();
            updateStatus('<strong>Origin Set</strong><br>Enter destination or click map', 'success', 'map-pin');
          });
        }
      });
      
      destinationInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchAddress(this.value, function(coords) {
            State.route.destination = coords;
            updateMarkers();
            updateStatus('<strong>Destination Set</strong><br>Ready to calculate route', 'success', 'flag');
          });
        }
      });
      
      // Initialize Feather icons
      feather.replace();
      
      // Initialize weight display
      updateWeightDisplay();
    });
  </script>
</body>
</html>
