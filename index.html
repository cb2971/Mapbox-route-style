<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route Finder with Obstacle Avoidance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  <!-- Try loading Mapbox GL JS with explicit CORS settings -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" crossorigin="anonymous"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Load Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  
  <!-- Load Mapbox GL Directions Plugin -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: #f0f0f0;
    }
     
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
     
    .sidebar {
      position: absolute;
      margin: 20px 20px 30px 20px;
      width: 15%;
      min-width: 300px;
      max-height: calc(100vh - 100px);
      top: 0;
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 5px;
      z-index: 1000;
    }
     
    .card {
      font-size: small;
      border-bottom: solid #d3d3d3 2px;
      margin-bottom: 6px;
    }
     
    .card-header {
      font-weight: bold;
      padding: 6px;
    }
     
    .no-route {
      background-color: #d3d3d3;
      color: #f00;
    }
     
    .obstacle-found {
      background-color: #f8d7da;
      color: #721c24;
    }
     
    .route-found {
      background-color: #d4edda;
      color: #155724;
    }
     
    .card-details {
      padding: 3px 6px;
    }

    #custom-route {
      position: absolute;
      background-color: #ffffff;
      width: 260px;
      height: 80px;
      right: 50px;
      top: 20px;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      font: 14px Helvetica Neue,Arial,Helvetica,sans-serif;
      z-index: 1000;
    }

    #routeWidth {
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 5px;
      width: 60px;
    }

    #routeColor {
      margin-bottom: 5px;
      width: 40px;
      height: 25px;
    }

    .map-style-selector {
      margin-bottom: 20px;
    }

    .map-style-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .instructions {
      background-color: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-loading {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .status-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .diagnostic-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
    }

    .network-test {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }
  </style>
</head>
 
<body>
  <div id="map"></div>
  
  <div class="sidebar">
    <div id="status-message" class="status-message status-loading">
      <strong>üîÑ Initializing...</strong><br>
      Starting diagnostic checks...
    </div>

    <div class="instructions">
      <strong>üõ£Ô∏è Route Finder with Obstacle Avoidance</strong><br><br>
      <strong>Features:</strong><br>
      ‚Ä¢ <strong>Search boxes</strong> for origin/destination<br>
      ‚Ä¢ <strong>Profile switcher</strong> (Traffic/Driving/Walking/Cycling)<br>
      ‚Ä¢ <strong>Zoom controls</strong> (+/-) on map<br>
      ‚Ä¢ <strong>Real-time obstacle detection</strong><br>
      ‚Ä¢ <strong>Multiple map styles</strong><br>
      ‚Ä¢ <strong>Visual clearance warnings</strong><br><br>
      <strong>Usage:</strong><br>
      1. Use search boxes to enter locations<br>
      2. Or click map to set origin/destination<br>
      3. Choose travel profile (driving/walking/etc.)<br>
      4. System analyzes routes for safety
    </div>

    <div class="map-style-selector">
      <label><strong>Map Style:</strong></label>
      <select id="styleSelector" disabled>
        <option value="">Loading styles...</option>
      </select>
    </div>

    <div class="network-test">
      <strong>üåê Network Diagnostics:</strong>
      <div id="diagnostic-results">Running tests...</div>
    </div>

    <button id="manual-init" onclick="manualInit()" disabled>üîÑ Retry Initialization</button>
    <button id="test-different-approach" onclick="testDifferentApproach()">üß™ Try Alternative Loading</button>
    <button id="direct-mapbox-test" onclick="testDirectMapbox()">üì° Test Direct Mapbox Access</button>

    <div id="reports"></div>
  </div>

  <div id="custom-route" style="display: none;">
    <label><strong>Route Customization:</strong></label><br>
    <label>Color:</label>
    <input type="color" name="routeColor" id="routeColor" value="#ff0000">
    <br>
    <label>Width:</label>
    <input type="number" name="routeWidth" id="routeWidth" value="8" min="1" max="20">
  </div>

  <script>
    // Global variables
    let map;
    let origin = null;
    let destination = null;
    let counter = 0;
    const maxAttempts = 50;

    // Your Mapbox access token
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';

    // Obstacle data
    const clearances = {
      type: 'FeatureCollection',
      features: [
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47426, 38.06673] },
          properties: { clearance: "13' 2\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47208, 38.06694] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.60485, 38.12184] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.61905, 37.87504] },
          properties: { clearance: "12' 0\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.55946, 38.30213] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27235, 38.04954] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27264, 37.82917] },
          properties: { clearance: "11' 6\"" }
        }
      ]
    };

    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status-message');
      statusEl.className = 'status-message status-' + type;
      statusEl.innerHTML = message;
    }

    function updateDiagnostics(message) {
      const diagnosticEl = document.getElementById('diagnostic-results');
      diagnosticEl.innerHTML += '<br>‚Ä¢ ' + message;
    }

    async function runNetworkDiagnostics() {
      updateDiagnostics('Testing basic internet connectivity...');
      
      // Test 1: Basic connectivity
      try {
        const response = await fetch('https://httpbin.org/get', { method: 'GET', mode: 'cors' });
        if (response.ok) {
          updateDiagnostics('‚úÖ Internet connection working');
        } else {
          updateDiagnostics('‚ö†Ô∏è Internet connection issues detected');
        }
      } catch (error) {
        updateDiagnostics('‚ùå No internet connection or severe restrictions');
      }

      // Test 2: Mapbox domain accessibility
      updateDiagnostics('Testing Mapbox domain access...');
      try {
        const response = await fetch('https://api.mapbox.com/ping', { method: 'GET', mode: 'cors' });
        updateDiagnostics('‚úÖ Mapbox domain accessible');
      } catch (error) {
        updateDiagnostics('‚ùå Cannot reach Mapbox domain: ' + error.message);
      }

      // Test 3: Check if we're in a restricted environment
      updateDiagnostics('Checking environment restrictions...');
      const userAgent = navigator.userAgent;
      if (userAgent.includes('Chrome') && window.location.protocol === 'file:') {
        updateDiagnostics('‚ö†Ô∏è Running from file:// - may cause CORS issues');
      } else if (window.location.protocol === 'https:') {
        updateDiagnostics('‚úÖ Running over HTTPS');
      } else {
        updateDiagnostics('‚ö†Ô∏è Not running over HTTPS - may cause issues');
      }

      // Test 4: Check for corporate restrictions
      updateDiagnostics('Checking for firewall/proxy...');
      const isRestricted = userAgent.includes('Corporate') || userAgent.includes('Enterprise');
      if (isRestricted) {
        updateDiagnostics('‚ö†Ô∏è Corporate environment detected');
      } else {
        updateDiagnostics('‚úÖ Standard browser environment');
      }
    }

    async function testDirectMapbox() {
      updateStatus('<strong>üì° Testing Direct Mapbox Access...</strong><br>Multiple connection tests running...', 'loading');
      
      const tests = [
        {
          name: 'Mapbox GL JS Library',
          url: 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js',
          method: 'HEAD'
        },
        {
          name: 'Mapbox Styles API',
          url: `https://api.mapbox.com/styles/v1/mapbox/streets-v11?access_token=${MAPBOX_TOKEN}`,
          method: 'GET'
        },
        {
          name: 'Mapbox Directions API',
          url: `https://api.mapbox.com/directions/v5/mapbox/driving/-84.5,38.05;-84.4,38.1?access_token=${MAPBOX_TOKEN}`,
          method: 'GET'
        },
        {
          name: 'Alternative CDN (unpkg)',
          url: 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js',
          method: 'HEAD'
        }
      ];

      let successCount = 0;
      let results = [];

      for (const test of tests) {
        try {
          const response = await fetch(test.url, { 
            method: test.method,
            mode: 'cors',
            headers: {
              'Accept': 'application/json,text/javascript,*/*'
            }
          });
          
          if (response.ok) {
            results.push(`‚úÖ ${test.name}: Success (${response.status})`);
            successCount++;
          } else {
            results.push(`‚ùå ${test.name}: Failed (${response.status})`);
          }
        } catch (error) {
          results.push(`‚ùå ${test.name}: ${error.message}`);
        }
      }

      updateDiagnostics('\n<strong>Direct Access Results:</strong>');
      results.forEach(result => updateDiagnostics(result));

      if (successCount >= 2) {
        updateStatus('<strong>‚úÖ Connection Tests Passed!</strong><br>Attempting to initialize map...', 'success');
        document.getElementById('manual-init').disabled = false;
        manualInit();
      } else {
        updateStatus('<strong>‚ùå Connection Tests Failed</strong><br>Network restrictions detected', 'error');
        showNetworkSolutions();
      }
    }

    function showNetworkSolutions() {
      const solutions = `
        <strong>üîß Possible Solutions:</strong><br><br>
        
        <strong>1. Corporate/School Network:</strong><br>
        ‚Ä¢ Ask IT to whitelist *.mapbox.com<br>
        ‚Ä¢ Try using mobile hotspot<br><br>
        
        <strong>2. Browser Issues:</strong><br>
        ‚Ä¢ Disable ad blockers for this site<br>
        ‚Ä¢ Try incognito/private mode<br>
        ‚Ä¢ Clear browser cache<br><br>
        
        <strong>3. Firewall/Security:</strong><br>
        ‚Ä¢ Check if firewall blocks Mapbox<br>
        ‚Ä¢ Temporarily disable VPN<br>
        ‚Ä¢ Try different browser<br><br>
        
        <strong>4. Local Development:</strong><br>
        ‚Ä¢ Run from web server (not file://)<br>
        ‚Ä¢ Use localhost or 127.0.0.1<br>
        ‚Ä¢ Enable CORS in browser
      `;
      
      updateStatus(solutions, 'error');
    }

    async function testDifferentApproach() {
      updateStatus('<strong>üß™ Trying Alternative Loading...</strong><br>Using different CDN and methods...', 'loading');
      
      // Try loading from unpkg instead
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js';
      script.onload = () => {
        updateStatus('<strong>‚úÖ Alternative CDN Success!</strong><br>Mapbox GL loaded from unpkg', 'success');
        manualInit();
      };
      script.onerror = () => {
        updateStatus('<strong>‚ùå Alternative CDN Failed</strong><br>All CDN sources blocked', 'error');
      };
      
      document.head.appendChild(script);
    }

    async function manualInit() {
      try {
        updateStatus('<strong>üó∫Ô∏è Initializing Map...</strong><br>Creating Mapbox instance...', 'loading');
        
        // Check if Mapbox GL is available
        if (typeof mapboxgl === 'undefined') {
          throw new Error('Mapbox GL JS library not loaded');
        }

        // Set access token
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        // Create map
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [-84.5, 38.05],
          zoom: 11,
          // Add these options to help with loading
          preserveDrawingBuffer: true,
          antialias: true
        });

        map.on('load', function() {
          updateStatus('<strong>‚úÖ Map Loaded Successfully!</strong><br>Ready for route planning', 'success');
          setupMapFeatures();
          document.getElementById('custom-route').style.display = 'block';
        });

        map.on('error', function(e) {
          console.error('Map error:', e);
          updateStatus('<strong>‚ùå Map Error:</strong><br>' + e.error.message, 'error');
        });

        // Add timeout for loading
        setTimeout(() => {
          if (!map.loaded()) {
            updateStatus('<strong>‚è±Ô∏è Map Loading Timeout</strong><br>Taking longer than expected...', 'error');
          }
        }, 15000);

      } catch (error) {
        console.error('Initialization failed:', error);
        updateStatus('<strong>‚ùå Initialization Failed:</strong><br>' + error.message, 'error');
      }
    }

    function setupMapFeatures() {
      // Add navigation controls (zoom +/- buttons)
      map.addControl(new mapboxgl.NavigationControl());
      
      // Add Mapbox Directions control
      const directions = new MapboxDirections({
        accessToken: MAPBOX_TOKEN,
        unit: 'imperial',
        profile: 'mapbox/driving-traffic',
        alternatives: false,
        geometries: 'geojson',
        controls: { instructions: false },
        flyTo: false
      });
      
      map.addControl(directions, 'top-left');
      
      // Listen for route events from directions control
      directions.on('route', function(event) {
        if (event.route && event.route.length > 0) {
          analyzeDirectionsRoute(event.route[0]);
        }
      });
      
      directions.on('clear', function() {
        clearRoute();
      });
      
      // Add obstacles
      const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
      
      map.addSource('obstacles', {
        type: 'geojson',
        data: obstacle
      });

      map.addLayer({
        id: 'obstacles-fill',
        type: 'fill',
        source: 'obstacles',
        paint: {
          'fill-color': '#f03b20',
          'fill-opacity': 0.5
        }
      });

      // Setup route layer for our custom analysis
      map.addSource('route-analysis', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      map.addLayer({
        id: 'route-analysis-layer',
        type: 'line',
        source: 'route-analysis',
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 'line-color': '#ff0000', 'line-width': 8, 'line-opacity': 0.8 }
      });

      // Setup route customization
      setupRouteCustomization();
      
      // Populate style selector
      populateStyleSelector();
      
      console.log('‚úÖ Map features setup complete');
    }

    function populateStyleSelector() {
      const select = document.getElementById('styleSelector');
      const styles = [
        { name: 'Streets', value: 'mapbox://styles/mapbox/streets-v11' },
        { name: 'Outdoors', value: 'mapbox://styles/mapbox/outdoors-v11' },
        { name: 'Light', value: 'mapbox://styles/mapbox/light-v10' },
        { name: 'Dark', value: 'mapbox://styles/mapbox/dark-v10' },
        { name: 'Satellite', value: 'mapbox://styles/mapbox/satellite-v9' },
        { name: 'Classic Vintage', value: 'mapbox://styles/cb29/ckxnmjiti0rvm14pby8w9si99' },
        { name: 'Classic Standard', value: 'mapbox://styles/cb29/ckxnnmex53n1b14m07t6sum48' }
      ];
      
      select.innerHTML = '';
      styles.forEach(style => {
        const option = document.createElement('option');
        option.value = style.value;
        option.textContent = style.name;
        select.appendChild(option);
      });
      
      select.disabled = false;
      select.addEventListener('change', function() {
        map.setStyle(this.value);
        map.once('style.load', setupMapFeatures);
      });
    }

    function handleMapClick(e) {
      const coords = [e.lngLat.lng, e.lngLat.lat];
      
      if (!origin) {
        setOrigin(coords);
      } else if (!destination) {
        setDestination(coords);
        findRoute();
      } else {
        clearRoute();
        setOrigin(coords);
      }
    }

    function setOrigin(coords) {
      origin = coords;
      updateMarkers();
      addReport('üü¢ Origin Set', `Starting point: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`, true);
    }

    function setDestination(coords) {
      destination = coords;
      updateMarkers();
      addReport('üî¥ Destination Set', `End point: ${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`, true);
    }

    function updateMarkers() {
      const features = [];
      
      if (origin) {
        features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: origin },
          properties: { color: '#00ff00' }
        });
      }
      
      if (destination) {
        features.push({
          type: 'Feature',
          geometry: { type: 'Point', coordinates: destination },
          properties: { color: '#ff6600' }
        });
      }

      map.getSource('markers').setData({
        type: 'FeatureCollection',
        features: features
      });
    }

    function findRoute() {
      const coords = origin.join(',') + ';' + destination.join(',');
      const url = `https://api.mapbox.com/directions/v5/mapbox/driving/${coords}?geometries=geojson&access_token=${MAPBOX_TOKEN}`;
      
      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            analyzeRoute(data.routes[0]);
          }
        })
        .catch(error => {
          addReport('‚ùå Route Error', 'Failed to fetch route: ' + error.message, false);
        });
    }

    function analyzeDirectionsRoute(route) {
      // Display the route for analysis
      map.getSource('route-analysis').setData(route.geometry);
      
      // Check for obstacles using Turf.js
      const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
      const clear = turf.booleanDisjoint(obstacle, route.geometry);
      
      const duration = Math.round(route.duration / 60);
      const distance = (route.distance / 1000).toFixed(1);
      
      if (clear) {
        // Safe route - make it green
        map.setPaintProperty('route-analysis-layer', 'line-color', '#00ff00');
        map.setPaintProperty('route-analysis-layer', 'line-width', 12);
        addReport('‚úÖ Safe Route Found!', `${duration} min, ${distance} km - avoids all obstacles`, true);
        updateStatus('<strong>‚úÖ Safe Route!</strong><br>' + duration + ' minutes, avoids all obstacles', 'success');
        
        // Apply custom color if user changed it
        const customColor = document.getElementById('routeColor').value;
        if (customColor !== '#ff0000') {
          map.setPaintProperty('route-analysis-layer', 'line-color', customColor);
        }
      } else {
        // Dangerous route - keep it red and add warning
        map.setPaintProperty('route-analysis-layer', 'line-color', '#ff0000');
        map.setPaintProperty('route-analysis-layer', 'line-width', 12);
        addReport('‚ö†Ô∏è Obstacle Warning', `${duration} min, ${distance} km - intersects clearance zones`, false);
        updateStatus('<strong>‚ö†Ô∏è Obstacle Warning!</strong><br>Route intersects low-clearance areas', 'error');
      }
      
      // Apply custom width
      const customWidth = document.getElementById('routeWidth').value;
      map.setPaintProperty('route-analysis-layer', 'line-width', parseInt(customWidth));
    }

    function setupRouteCustomization() {
      // Route color customization
      document.getElementById('routeColor').addEventListener('change', function() {
        if (map.getLayer('route-analysis-layer')) {
          map.setPaintProperty('route-analysis-layer', 'line-color', this.value);
        }
      });

      // Route width customization
      document.getElementById('routeWidth').addEventListener('change', function() {
        if (map.getLayer('route-analysis-layer')) {
          map.setPaintProperty('route-analysis-layer', 'line-width', parseInt(this.value));
        }
      });
    }

    function addReport(title, details, isSuccess) {
      const reports = document.getElementById('reports');
      const card = document.createElement('div');
      card.className = 'card';
      
      const header = document.createElement('div');
      header.className = `card-header ${isSuccess ? 'route-found' : 'obstacle-found'}`;
      header.textContent = title;
      
      const body = document.createElement('div');
      body.className = 'card-details';
      body.textContent = details;
      
      card.appendChild(header);
      card.appendChild(body);
      reports.insertBefore(card, reports.firstChild);
    }

    function clearRoute() {
      if (map && map.getSource('route-analysis')) {
        map.getSource('route-analysis').setData({ type: 'FeatureCollection', features: [] });
      }
      
      document.getElementById('reports').innerHTML = '';
      updateStatus('<strong>üéØ Ready for New Route</strong><br>Use the search boxes or click on map', 'loading');
    }

    // Start diagnostics immediately
    window.addEventListener('load', function() {
      setTimeout(() => {
        runNetworkDiagnostics();
        testDirectMapbox();
      }, 1000);
    });

    console.log('üõ£Ô∏è Route Finder loaded, starting network diagnostics...');
  </script>
</body>
</html>
