<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route Finder with Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    #map {
      width: 100%;
      height: 400px;
    }
    .card {
      background: #fff;
      margin: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card-header {
      padding: 1em;
      font-weight: bold;
      cursor: pointer;
      background: #eee;
      border-bottom: 1px solid #ddd;
    }
    .card-content {
      padding: 1em;
    }
    .form-group {
      margin-bottom: 1em;
    }
    .form-label {
      display: block;
      margin-bottom: 0.5em;
    }
    .form-input, .form-select {
      width: 100%;
      padding: 0.5em;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .btn {
      padding: 0.5em 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 0.5em;
    }
    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Export Map Controls -->
  <div class="card" id="map-export-controls">
    <div class="card-header" onclick="toggleSection('map-export-controls')">
      ◈ Export Map
    </div>
    <div class="card-content">
      <div class="form-group">
        <label class="form-label">Print Size</label>
        <select class="form-select" id="printSize">
          <option value="16x20">16x20"</option>
          <option value="18x24">18x24"</option>
          <option value="A2">A2 (42x59.4cm)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">DPI</label>
        <select class="form-select" id="dpi">
          <option value="300">300</option>
          <option value="150">150</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Bleed (inches)</label>
        <input type="number" class="form-input" id="bleedAmount" value="0.25" step="0.01" />
      </div>
      <div class="form-group">
        <label class="form-label">Filename</label>
        <input type="text" class="form-input" id="filename" value="exported_map" />
      </div>
      <div class="form-group">
        <label class="form-label">Format</label>
        <select class="form-select" id="format">
          <option value="png">PNG</option>
          <option value="jpeg">JPG</option>
        </select>
      </div>
      <button class="btn btn-primary" onclick="exportMapImage()">Export</button>
    </div>
  </div>

  <!-- Hidden export canvas -->
  <div id="export-map" style="width:0;height:0;position:absolute;top:-9999px;"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-122.42, 37.78],
      zoom: 10
    });

    function inchesToPixels(inches, dpi) {
      return Math.round(inches * dpi);
    }

    function getExportDimensions(size, dpi, bleed) {
      const sizes = {
        "16x20": [16, 20],
        "18x24": [18, 24],
        "A2": [16.54, 23.39]
      };
      let [w, h] = sizes[size] || [16, 20];
      w += bleed * 2;
      h += bleed * 2;
      return [inchesToPixels(w, dpi), inchesToPixels(h, dpi)];
    }

    function exportMapImage() {
      const size = document.getElementById("printSize").value;
      const dpi = parseInt(document.getElementById("dpi").value);
      const bleed = parseFloat(document.getElementById("bleedAmount").value);
      const filename = document.getElementById("filename").value;
      const format = document.getElementById("format").value;
      const [width, height] = getExportDimensions(size, dpi, bleed);

      const exportContainer = document.getElementById("export-map");
      exportContainer.style.width = width + "px";
      exportContainer.style.height = height + "px";

      const exportMap = new mapboxgl.Map({
        container: "export-map",
        style: map.getStyle(),
        center: map.getCenter(),
        zoom: map.getZoom(),
        interactive: false,
        preserveDrawingBuffer: true
      });

      exportMap.once("idle", () => {
        try {
          const canvas = exportMap.getCanvas();
          const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
          const dataURL = canvas.toDataURL(mimeType);
          const link = document.createElement("a");
          link.download = filename + "." + format;
          link.href = dataURL;
          link.click();
          exportMap.remove();
        } catch (e) {
          alert("❌ Export failed.");
          console.error(e);
          exportMap.remove();
        }
      });
    }

    function toggleSection(id) {
      const content = document.getElementById(id).querySelector('.card-content');
      content.style.display = content.style.display === 'none' ? 'block' : 'none';
    }
  </script>
</body>
</html>
