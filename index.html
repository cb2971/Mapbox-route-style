<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route Finder with Multiple Routes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  <!-- Load Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Load Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: #f0f0f0;
    }
     
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
     
    .sidebar {
      position: absolute;
      margin: 20px 20px 30px 20px;
      width: 15%;
      min-width: 320px;
      max-height: calc(100vh - 100px);
      top: 0;
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 5px;
      z-index: 1000;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }

    .toggle-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 40px;
      background-color: #fff;
      border: 2px solid #007bff;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      z-index: 1001;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: left 0.3s ease;
    }

    .toggle-btn.sidebar-hidden {
      left: 20px;
    }

    .toggle-btn.sidebar-visible {
      left: 380px;
    }
     
    .card {
      font-size: small;
      border-bottom: solid #d3d3d3 2px;
      margin-bottom: 10px;
      padding-bottom: 10px;
    }
     
    .card-header {
      font-weight: bold;
      padding: 6px;
      background-color: #f8f9fa;
      border-radius: 3px;
      margin-bottom: 8px;
    }
     
    .control-panel {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .input-group {
      margin-bottom: 10px;
    }

    .input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .route-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 10px;
    }

    .route-controls input[type="color"] {
      width: 40px;
      height: 30px;
      padding: 0;
      border: none;
    }

    .route-controls input[type="number"] {
      width: 60px;
    }

    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-loading {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .status-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .small-btn {
      width: auto;
      padding: 5px 10px;
      margin: 2px;
      font-size: 12px;
    }

    .diagnostic-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
    }

    .network-test {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }

    .zoom-controls {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .zoom-controls button {
      width: 50px;
      height: 40px;
      font-size: 18px;
      font-weight: bold;
    }

    .waypoint-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }

    .waypoint-item {
      display: flex;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
      background-color: white;
      margin: 2px;
      border-radius: 3px;
    }

    .waypoint-item:last-child {
      border-bottom: none;
    }

    .waypoint-number {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background-color: #007bff;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      margin-right: 10px;
      flex-shrink: 0;
    }

    .waypoint-text {
      flex: 1;
      font-size: 12px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .waypoint-controls {
      display: flex;
      gap: 5px;
      flex-shrink: 0;
    }

    .waypoint-controls button {
      width: 25px;
      height: 25px;
      padding: 0;
      font-size: 12px;
      margin: 0;
    }

    /* Route Management Styles */
    .route-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid #dee2e6;
      padding-bottom: 10px;
    }

    .route-tab {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      border-radius: 4px 4px 0 0;
      background-color: #f8f9fa;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 5px;
      min-width: 80px;
      justify-content: center;
    }

    .route-tab.active {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
    }

    .route-tab .color-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.2);
    }

    .route-tab .close-btn {
      margin-left: 5px;
      background: none;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      width: auto;
      height: auto;
      font-size: 14px;
      font-weight: bold;
    }

    .route-tab .close-btn:hover {
      background-color: rgba(255,255,255,0.2);
      border-radius: 50%;
    }

    .route-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      margin-top: 10px;
    }

    .route-list-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      background-color: white;
      margin: 2px;
      border-radius: 3px;
    }

    .route-list-item:last-child {
      border-bottom: none;
    }

    .route-info {
      flex: 1;
      font-size: 12px;
    }

    .route-name {
      font-weight: bold;
      margin-bottom: 2px;
    }

    .route-status {
      color: #666;
      font-size: 11px;
    }

    .visibility-btn {
      width: 30px;
      height: 30px;
      padding: 0;
      font-size: 14px;
      margin: 0;
    }

    .visibility-btn.hidden {
      background-color: #6c757d;
    }
  </style>
</head>
 
<body>
  <div id="map"></div>
  
  <div class="toggle-btn sidebar-visible" id="toggle-btn" onclick="toggleSidebar()">
    ‚ò∞
  </div>
  
  <div class="sidebar" id="sidebar">
    <div id="status-message" class="status-message status-loading">
      <strong>üîÑ Loading...</strong><br>
      Initializing map...
    </div>

    <!-- Route Management Section -->
    <div class="control-panel">
      <div class="card-header">üó∫Ô∏è Route Management</div>
      
      <div class="route-tabs" id="route-tabs">
        <!-- Route tabs will be dynamically generated -->
      </div>
      
      <button onclick="createNewRoute()">‚ûï New Route</button>
      
      <div class="route-list" id="route-list" style="display: none;">
        <!-- Route list items will be dynamically generated -->
      </div>
      
      <button onclick="toggleRouteList()" id="route-list-toggle" style="display: none;">üìã Show All Routes</button>
    </div>

    <!-- Current Route Controls -->
    <div class="control-panel" id="current-route-panel">
      <div class="card-header" id="current-route-header">üéØ Current Route</div>
      
      <div class="input-group">
        <label>üü¢ Starting Point:</label>
        <input type="text" id="origin-input" placeholder="Enter address or place name">
        <button onclick="geocodeOrigin()" style="margin-top: 5px; font-size: 12px; height: 30px;">üìç Find Location</button>
      </div>
      
      <div class="input-group">
        <label>üî¥ Destination:</label>
        <input type="text" id="destination-input" placeholder="Enter address or place name">
        <button onclick="geocodeDestination()" style="margin-top: 5px; font-size: 12px; height: 30px;">üìç Find Location</button>
      </div>
      
      <div class="input-group">
        <label>üîµ Waypoints:</label>
        <input type="text" id="waypoint-input" placeholder="Enter intermediate stop">
        <div style="display: flex; gap: 5px; margin-top: 5px;">
          <button onclick="addWaypoint()" style="flex: 1; font-size: 12px; height: 30px;">‚ûï Add Waypoint</button>
          <button onclick="toggleWaypointMode()" id="waypoint-mode-btn" style="flex: 1; font-size: 12px; height: 30px;">üìç Click Map</button>
        </div>
        
        <div id="waypoint-list" class="waypoint-list" style="margin-top: 10px; display: none;">
          <!-- Waypoints will be added here dynamically -->
        </div>
      </div>
      
      <div class="input-group">
        <label>üöó Travel Mode:</label>
        <select id="profile-select">
          <option value="driving">üöó Driving</option>
          <option value="walking">üö∂ Walking</option>
          <option value="cycling">üö¥ Cycling</option>
        </select>
      </div>
      
      <button onclick="findRoute()">üó∫Ô∏è Find Route</button>
      <button onclick="clearCurrentRoute()">üóëÔ∏è Clear Route</button>
      
      <div class="route-controls">
        <label>Color:</label>
        <input type="color" id="routeColor" value="#ff0000" onchange="updateCurrentRouteStyle()">
        <label>Width:</label>
        <input type="number" id="routeWidth" value="8" min="1" max="20" onchange="updateCurrentRouteStyle()">
      </div>
    </div>

    <!-- Map Controls -->
    <div class="control-panel">
      <div class="zoom-controls">
        <button onclick="zoomIn()">+</button>
        <button onclick="zoomOut()">-</button>
        <button onclick="fitToData()" style="width: auto; flex: 1; font-size: 14px;">üìç Fit to Points</button>
      </div>
      
      <div class="zoom-controls">
        <button onclick="toggleCenterMode()" id="center-mode-btn" style="width: auto; flex: 1; font-size: 14px;">üéØ Set Center</button>
        <button onclick="toggleCenterIcon()" id="center-icon-btn" style="width: 50px; font-size: 14px;">üëÅÔ∏è</button>
      </div>
      
      <div class="input-group" style="margin-top: 10px;">
        <label style="font-size: 12px;">Custom Center (lat, lng):</label>
        <input type="text" id="center-input" placeholder="38.0500, -84.5000" style="font-size: 12px;">
        <button onclick="setCenterFromInput()" style="margin-top: 5px; font-size: 12px; height: 30px;">üìç Apply Center</button>
        <button onclick="clearCustomCenter()" style="margin-top: 5px; font-size: 12px; height: 30px;">‚ùå Clear Center</button>
      </div>
    </div>

    <!-- Map Styles -->
    <div class="control-panel">
      <div class="input-group">
        <label><strong>Default Map Styles:</strong></label>
        <select id="styleSelector" onchange="changeMapStyle()">
          <option value="mapbox://styles/mapbox/streets-v11">üìç Streets</option>
          <option value="mapbox://styles/mapbox/outdoors-v11">üå≤ Outdoors</option>
          <option value="mapbox://styles/mapbox/light-v10">‚òÄÔ∏è Light</option>
          <option value="mapbox://styles/mapbox/dark-v10">üåô Dark</option>
          <option value="mapbox://styles/mapbox/satellite-v9">üõ∞Ô∏è Satellite</option>
          <option value="mapbox://styles/mapbox/satellite-streets-v11">üó∫Ô∏è Satellite Streets</option>
        </select>
      </div>
      
      <div class="input-group">
        <label><strong>Your Custom Styles:</strong></label>
        <select id="customStyleSelector" onchange="changeMapStyle('custom')">
          <option value="">Select custom style...</option>
          <option value="mapbox://styles/cb29/ckxnnmex53n1b14m07t6sum48">üé® Classic Standard</option>
          <option value="mapbox://styles/cb29/ckxnmjiti0rvm14pby8w9si99">üé® Classic Vintage</option>
          <option value="mapbox://styles/cb29/ckxov33jj3le314ueu15gl6yh">üé® Dark Digital</option>
          <option value="mapbox://styles/cb29/ckxmhuc4k2gxm14s0eq1htzns">üé® Dark Monochrome</option>
          <option value="mapbox://styles/cb29/ckxs1bfov2cay14mnx6nvrzxt">üé® Dark Night Mode</option>
          <option value="mapbox://styles/cb29/ckwgtu6ly20cr15qiy9i2ftsz">üé® Light Engraved</option>
          <option value="mapbox://styles/cb29/ckxntkwjq4flv14ld7uisp5b1">üé® Light High Contrast</option>
          <option value="mapbox://styles/cb29/ckxouv50s02lw14r2jiyvnvxh">üé® Light Pencil Sketch</option>
          <option value="mapbox://styles/cb29/ckxtl08qj2gb215p8y2blzxur">üé® Pastel Blue</option>
          <option value="mapbox://styles/cb29/ckxtlkuk8l10zj14pk8irf7owt">üé® Pastel Cool</option>
          <option value="mapbox://styles/cb29/ckxtl2a2s0yot14nw9pbn2733">üé® Pastel Pink</option>
          <option value="mapbox://styles/cb29/ckxtl35nk4hsb15mry8rwlg4l">üé® Pastel Yellow</option>
          <option value="mapbox://styles/cb29/ckxmjckme2if514s0v3xq4vxy">üé® Satellite Streets</option>
          <option value="mapbox://styles/cb29/ckxrnuq691z6h14mnuy5jpk5c">üé® Topography Colorful</option>
          <option value="mapbox://styles/cb29/ckxnp39kb5eyw14oaan01mkp0">üé® Topography Globe</option>
          <option value="mapbox://styles/cb29/ckxnkf6rs60r214uc0j42vbj4">üé® Topography Outdoor</option>
          <option value="mapbox://styles/cb29/ckxnqwyww0sri14p9skglgshs">üé® Topography Subtle</option>
          <option value="mapbox://styles/cb29/ckxno9jbk3nn714s6vjah6fwb">üé® Topography Vintage</option>
          <option value="mapbox://styles/cb29/ckxrrtfqk0oir15my0y9tpjvj">üé® Unique Colorful</option>
          <option value="mapbox://styles/cb29/ckxovchyg4tfj14s6d7u559tj">üé® Unique Comic Book 1</option>
          <option value="mapbox://styles/cb29/ckxov6vgm66g214o064dp3vda">üé® Unique Comic Book 2</option>
          <option value="mapbox://styles/cb29/ckxove5sy174l15mq6h82hwxk">üé® Unique Dusty Western</option>
          <option value="mapbox://styles/cb29/ckxoup98z4sv514m0q988ltie">üé® Unique Picture Book</option>
          <option value="mapbox://styles/cb29/ckxov1ris0n2415p4e9gn8oxu">üé® Unique Treasure Map</option>
          <option value="mapbox://styles/cb29/ckxous4km02k114m523qh0k9y">üé® Unique Woodcut</option>
        </select>
      </div>
    </div>

    <div class="network-test">
      <strong>üîç Debug Info:</strong>
      <div id="diagnostic-results" class="diagnostic-info">Starting...</div>
    </div>

    <button onclick="initializeMap()">üîÑ Try Initialize Map</button>
    <button onclick="debugStatus()">üîç Debug Status</button>

    <div id="reports"></div>
  </div>

  <script>
    // Your Mapbox access token
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';

    // Global variables
    let map = null;
    let customCenter = null;
    let isSettingCenter = false;
    let showCenterIcon = true;
    let nextRouteId = 1;
    let currentRouteId = null;
    let routes = new Map();
    let routeListVisible = false;
    let isSettingOrigin = true;
    let isAddingWaypoint = false;

    // Route colors for new routes
    const routeColors = [
      '#ff0000', '#00ff00', '#0066ff', '#ff6600', '#ff00ff', 
      '#00ffff', '#ffff00', '#990000', '#009900', '#000099'
    ];

    // Route structure
    function createEmptyRoute(id = null) {
      return {
        id: id || nextRouteId++,
        name: `Route ${id || nextRouteId - 1}`,
        origin: null,
        destination: null,
        waypoints: [],
        profile: 'driving',
        color: routeColors[(id || nextRouteId - 1) % routeColors.length],
        width: 8,
        routeData: null,
        visible: true,
        status: 'empty'
      };
    }

    // Obstacle data
    const clearances = {
      type: 'FeatureCollection',
      features: [
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47426, 38.06673] },
          properties: { clearance: "13' 2\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47208, 38.06694] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.60485, 38.12184] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.61905, 37.87504] },
          properties: { clearance: "12' 0\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.55946, 38.30213] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27235, 38.04954] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27264, 37.82917] },
          properties: { clearance: "11' 6\"" }
        }
      ]
    };

    function logDebug(message) {
      console.log(message);
      const debugEl = document.getElementById('diagnostic-results');
      if (debugEl) {
        debugEl.innerHTML += message + '<br>';
        debugEl.scrollTop = debugEl.scrollHeight;
      }
      // Also try to show in status if debug element isn't working
      try {
        const statusEl = document.getElementById('status-message');
        if (statusEl && !debugEl) {
          statusEl.innerHTML += '<br>' + message;
        }
      } catch (e) {}
    }

    function updateStatus(message, type) {
      const statusEl = document.getElementById('status-message');
      if (statusEl) {
        statusEl.className = 'status-message status-' + type;
        statusEl.innerHTML = message;
      }
      console.log('Status: ' + message);
    }

    function debugStatus() {
      logDebug('=== DEBUG STATUS ===');
      logDebug('Mapbox GL exists: ' + (typeof mapboxgl !== 'undefined'));
      logDebug('Map instance: ' + (map ? 'exists' : 'null'));
      logDebug('Document ready: ' + document.readyState);
      logDebug('Routes count: ' + routes.size);
      logDebug('Current route: ' + currentRouteId);
      logDebug('=== END DEBUG ===');
    }

    function initializeMap() {
      logDebug('Starting map initialization...');
      updateStatus('<strong>üó∫Ô∏è Initializing...</strong><br>Creating map instance...', 'loading');
      
      if (typeof mapboxgl === 'undefined') {
        logDebug('‚ùå Mapbox GL not found');
        updateStatus('<strong>‚ùå Mapbox GL Missing</strong><br>Library failed to load', 'error');
        return;
      }
      
      logDebug('‚úÖ Mapbox GL found');
      
      mapboxgl.accessToken = MAPBOX_TOKEN;
      
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [-84.5, 38.05],
        zoom: 10
      });
      
      map.on('load', function() {
        logDebug('‚úÖ Map loaded!');
        updateStatus('<strong>‚úÖ Ready!</strong><br>Click map or enter addresses', 'success');
        setupMapFeatures();
        
        // Create first route
        createNewRoute();
      });
      
      map.on('error', function(e) {
        logDebug('‚ùå Map error: ' + (e.error ? e.error.message : 'unknown'));
        updateStatus('<strong>‚ùå Map Error</strong><br>Failed to load', 'error');
      });
      
      map.on('click', handleMapClick);
    }

    function setupMapFeatures() {
      // Add obstacles
      const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
      
      map.addSource('obstacles', {
        type: 'geojson',
        data: obstacle
      });

      map.addLayer({
        id: 'obstacles',
        type: 'fill',
        source: 'obstacles',
        paint: {
          'fill-color': '#ff0000',
          'fill-opacity': 0.3
        }
      });
      
      // Add center point source
      map.addSource('center-point', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      map.addLayer({
        id: 'center-point-symbol',
        type: 'symbol',
        source: 'center-point',
        layout: {
          'text-field': '‚äï',
          'text-size': 20,
          'text-allow-overlap': true,
          'text-ignore-placement': true
        },
        paint: {
          'text-color': '#ff0000',
          'text-halo-color': '#ffffff',
          'text-halo-width': 2
        }
      });
      
      logDebug('‚úÖ Map features setup complete');
    }

    // Route Management Functions
    function createNewRoute() {
      const newRoute = createEmptyRoute();
      routes.set(newRoute.id, newRoute);
      
      // Add map sources for this route
      addRouteToMap(newRoute.id);
      
      // Switch to new route
      switchToRoute(newRoute.id);
      
      updateRouteTabs();
      updateRouteList();
      
      logDebug(`Created new route ${newRoute.id}`);
    }

    function addRouteToMap(routeId) {
      const route = routes.get(routeId);
      if (!route || !map) return;

      // Add route line source
      map.addSource(`route-${routeId}`, {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      map.addLayer({
        id: `route-${routeId}`,
        type: 'line',
        source: `route-${routeId}`,
        layout: { 'line-join': 'round', 'line-cap': 'round' },
        paint: { 
          'line-color': route.color, 
          'line-width': route.width,
          'line-opacity': route.visible ? 1 : 0
        }
      });

      // Add waypoints source
      map.addSource(`waypoints-${routeId}`, {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });

      map.addLayer({
        id: `waypoints-${routeId}`,
        type: 'circle',
        source: `waypoints-${routeId}`,
        paint: {
          '
