<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Route Finder with Obstacle Avoidance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   
  <!-- Try loading Mapbox GL JS with explicit CORS settings -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js" crossorigin="anonymous"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  
  <!-- Load Turf.js -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  
  <!-- Load Mapbox GL Directions Plugin -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />
  
  <style type="text/css">
    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background-color: #f0f0f0;
    }
     
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
     
    .sidebar {
      position: absolute;
      margin: 20px 20px 30px 20px;
      width: 15%;
      min-width: 300px;
      max-height: calc(100vh - 100px);
      top: 0;
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      border-radius: 5px;
      z-index: 1000;
    }
     
    .card {
      font-size: small;
      border-bottom: solid #d3d3d3 2px;
      margin-bottom: 6px;
    }
     
    .card-header {
      font-weight: bold;
      padding: 6px;
    }
     
    .no-route {
      background-color: #d3d3d3;
      color: #f00;
    }
     
    .obstacle-found {
      background-color: #f8d7da;
      color: #721c24;
    }
     
    .route-found {
      background-color: #d4edda;
      color: #155724;
    }
     
    .card-details {
      padding: 3px 6px;
    }

    #custom-route {
      position: absolute;
      background-color: #ffffff;
      width: 260px;
      height: 80px;
      right: 50px;
      top: 20px;
      padding: 15px;
      border-radius: 5px;
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
      font: 14px Helvetica Neue,Arial,Helvetica,sans-serif;
      z-index: 1000;
    }

    #routeWidth {
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      padding: 5px;
      width: 60px;
    }

    #routeColor {
      margin-bottom: 5px;
      width: 40px;
      height: 25px;
    }

    .map-style-selector {
      margin-bottom: 20px;
    }

    .map-style-selector select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .instructions {
      background-color: #e8f4fd;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .status-loading {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .status-success {
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .status-error {
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .diagnostic-info {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 12px;
      font-family: monospace;
    }

    .network-test {
      background-color: #e3f2fd;
      border: 1px solid #90caf9;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
      font-size: 13px;
    }
  </style>
</head>
 
<body>
  <div id="map"></div>
  
  <div class="sidebar">
    <div id="status-message" class="status-message status-loading">
      <strong>üîÑ Initializing...</strong><br>
      Starting diagnostic checks...
    </div>

    <div class="instructions">
      <strong>üõ£Ô∏è Route Finder with Obstacle Avoidance</strong><br><br>
      <strong>Features:</strong><br>
      ‚Ä¢ <strong>Search boxes</strong> for origin/destination<br>
      ‚Ä¢ <strong>Profile switcher</strong> (Traffic/Driving/Walking/Cycling)<br>
      ‚Ä¢ <strong>Zoom controls</strong> (+/-) on map<br>
      ‚Ä¢ <strong>Real-time obstacle detection</strong><br>
      ‚Ä¢ <strong>Multiple map styles</strong><br>
      ‚Ä¢ <strong>Visual clearance warnings</strong><br><br>
      <strong>Usage:</strong><br>
      1. Use search boxes to enter locations<br>
      2. Or click map to set origin/destination<br>
      3. Choose travel profile (driving/walking/etc.)<br>
      4. System analyzes routes for safety
    </div>

    <div class="map-style-selector">
      <label><strong>Map Style:</strong></label>
      <select id="styleSelector" disabled>
        <option value="">Loading styles...</option>
      </select>
    </div>

    <div class="network-test">
      <strong>üåê Network Diagnostics:</strong>
      <div id="diagnostic-results">Running tests...</div>
    </div>

    <button id="manual-init" onclick="manualInit()" disabled>üîÑ Retry Initialization</button>
    <button id="test-different-approach" onclick="testDifferentApproach()">üß™ Try Alternative Loading</button>
    <button id="direct-mapbox-test" onclick="testDirectMapbox()">üì° Test Direct Mapbox Access</button>

    <div id="reports"></div>
  </div>

  <div id="custom-route" style="display: none;">
    <label><strong>Route Customization:</strong></label><br>
    <label>Color:</label>
    <input type="color" name="routeColor" id="routeColor" value="#ff0000">
    <br>
    <label>Width:</label>
    <input type="number" name="routeWidth" id="routeWidth" value="8" min="1" max="20">
  </div>

  <script>
    // Global variables
    let map;
    let origin = null;
    let destination = null;
    let counter = 0;
    const maxAttempts = 50;
    
    // Global variable to track the directions control
    let directionsControl = null;

    // Your Mapbox access token
    const MAPBOX_TOKEN = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';

    // Obstacle data
    const clearances = {
      type: 'FeatureCollection',
      features: [
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47426, 38.06673] },
          properties: { clearance: "13' 2\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.47208, 38.06694] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.60485, 38.12184] },
          properties: { clearance: "13' 7\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.61905, 37.87504] },
          properties: { clearance: "12' 0\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.55946, 38.30213] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27235, 38.04954] },
          properties: { clearance: "13' 6\"" }
        },
        {
          type: 'Feature',
          geometry: { type: 'Point', coordinates: [-84.27264, 37.82917] },
          properties: { clearance: "11' 6\"" }
        }
      ]
    };

    function updateStatus(message, type = 'loading') {
      const statusEl = document.getElementById('status-message');
      statusEl.className = 'status-message status-' + type;
      statusEl.innerHTML = message;
    }

    function updateDiagnostics(message) {
      const diagnosticEl = document.getElementById('diagnostic-results');
      diagnosticEl.innerHTML += '<br>‚Ä¢ ' + message;
    }

    async function runNetworkDiagnostics() {
      updateDiagnostics('Testing basic internet connectivity...');
      
      // Test 1: Basic connectivity
      try {
        const response = await fetch('https://httpbin.org/get', { 
          method: 'GET', 
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        if (response.ok) {
          updateDiagnostics('‚úÖ Internet connection working');
        } else {
          updateDiagnostics('‚ö†Ô∏è Internet connection issues detected');
        }
      } catch (error) {
        updateDiagnostics('‚ùå No internet connection or severe restrictions');
      }

      // Test 2: Simplified Mapbox test - just check if we can reach the domain
      updateDiagnostics('Testing Mapbox domain access...');
      try {
        // Use a simpler approach - try to load the JS file directly
        const response = await fetch('https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js', { 
          method: 'HEAD',
          mode: 'cors'
        });
        updateDiagnostics('‚úÖ Mapbox domain accessible');
      } catch (error) {
        updateDiagnostics('‚ùå Cannot reach Mapbox domain - trying alternative approach');
        // Try alternative CDN
        try {
          const altResponse = await fetch('https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js', {
            method: 'HEAD',
            mode: 'cors'
          });
          updateDiagnostics('‚úÖ Alternative CDN accessible');
        } catch (altError) {
          updateDiagnostics('‚ùå All CDNs blocked: ' + altError.message);
        }
      }

      // Test 3: Check environment
      updateDiagnostics('Checking environment restrictions...');
      const userAgent = navigator.userAgent;
      if (userAgent.includes('Chrome') && window.location.protocol === 'file:') {
        updateDiagnostics('‚ö†Ô∏è Running from file:// - may cause CORS issues');
      } else if (window.location.protocol === 'https:') {
        updateDiagnostics('‚úÖ Running over HTTPS');
      } else {
        updateDiagnostics('‚ö†Ô∏è Not running over HTTPS - may cause issues');
      }

      // Test 4: Check for GitHub Pages specific issues
      if (window.location.hostname.includes('github.io')) {
        updateDiagnostics('‚ÑπÔ∏è GitHub Pages detected - using HTTPS automatically');
      }
    }

    async function testDirectMapbox() {
      updateStatus('<strong>üì° Testing Direct Mapbox Access...</strong><br>Multiple connection tests running...', 'loading');
      
      const tests = [
        {
          name: 'Mapbox GL JS Library',
          url: 'https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js',
          method: 'HEAD'
        },
        {
          name: 'Alternative CDN (unpkg)',
          url: 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js',
          method: 'HEAD'
        }
      ];

      let successCount = 0;
      let results = [];

      for (const test of tests) {
        try {
          const response = await fetch(test.url, { 
            method: test.method,
            mode: 'cors',
            headers: {
              'Accept': 'application/javascript,text/javascript,*/*'
            }
          });
          
          if (response.ok) {
            results.push(`‚úÖ ${test.name}: Success (${response.status})`);
            successCount++;
          } else {
            results.push(`‚ùå ${test.name}: Failed (${response.status})`);
          }
        } catch (error) {
          results.push(`‚ùå ${test.name}: ${error.message}`);
        }
      }

      updateDiagnostics('\n<strong>Direct Access Results:</strong>');
      results.forEach(result => updateDiagnostics(result));

      if (successCount >= 1) {
        updateStatus('<strong>‚úÖ Connection Tests Passed!</strong><br>Attempting to initialize map...', 'success');
        document.getElementById('manual-init').disabled = false;
        manualInit();
      } else {
        updateStatus('<strong>‚ùå Connection Tests Failed</strong><br>Network restrictions detected', 'error');
        showNetworkSolutions();
      }
    }

    function showNetworkSolutions() {
      const solutions = `
        <strong>üîß Possible Solutions:</strong><br><br>
        
        <strong>1. GitHub Pages Issues:</strong><br>
        ‚Ä¢ Ensure repository is public<br>
        ‚Ä¢ Check GitHub Pages settings<br>
        ‚Ä¢ Try using raw.githubusercontent.com URLs<br><br>
        
        <strong>2. Browser Issues:</strong><br>
        ‚Ä¢ Disable ad blockers for this site<br>
        ‚Ä¢ Try incognito/private mode<br>
        ‚Ä¢ Clear browser cache<br><br>
        
        <strong>3. Network/Firewall:</strong><br>
        ‚Ä¢ Check if firewall blocks Mapbox<br>
        ‚Ä¢ Temporarily disable VPN<br>
        ‚Ä¢ Try different browser<br><br>
        
        <strong>4. CORS Issues:</strong><br>
        ‚Ä¢ Serve from HTTPS (required by Mapbox)<br>
        ‚Ä¢ Use proper domain (not file://)<br>
        ‚Ä¢ Enable CORS in browser (dev only)
      `;
      
      updateStatus(solutions, 'error');
    }

    async function testDifferentApproach() {
      updateStatus('<strong>üß™ Trying Alternative Loading...</strong><br>Using different CDN and methods...', 'loading');
      
      // Remove existing script if any
      const existingScript = document.querySelector('script[src*="mapbox-gl"]');
      if (existingScript) {
        existingScript.remove();
      }
      
      // Try loading from unpkg instead
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/mapbox-gl@2.15.0/dist/mapbox-gl.js';
      script.crossOrigin = 'anonymous';
      script.onload = () => {
        updateStatus('<strong>‚úÖ Alternative CDN Success!</strong><br>Mapbox GL loaded from unpkg', 'success');
        manualInit();
      };
      script.onerror = () => {
        updateStatus('<strong>‚ùå Alternative CDN Failed</strong><br>All CDN sources blocked', 'error');
        showNetworkSolutions();
      };
      
      document.head.appendChild(script);
    }

    async function manualInit() {
      try {
        updateStatus('<strong>üó∫Ô∏è Initializing Map...</strong><br>Creating Mapbox instance...', 'loading');
        
        // Check if Mapbox GL is available
        if (typeof mapboxgl === 'undefined') {
          throw new Error('Mapbox GL JS library not loaded');
        }

        // Set access token
        mapboxgl.accessToken = MAPBOX_TOKEN;
        
        // Create map
        map = new mapboxgl.Map({
          container: 'map',
          style: 'mapbox://styles/mapbox/streets-v11',
          center: [-84.5, 38.05],
          zoom: 11,
          // Add these options to help with loading
          preserveDrawingBuffer: true,
          antialias: true
        });

        map.on('load', function() {
          updateStatus('<strong>‚úÖ Map Loaded Successfully!</strong><br>Ready for route planning', 'success');
          setupMapFeatures();
          populateStyleSelector();
          document.getElementById('custom-route').style.display = 'block';
        });

        map.on('error', function(e) {
          console.error('Map error:', e);
          updateStatus('<strong>‚ùå Map Error:</strong><br>' + e.error.message, 'error');
        });

        // Add timeout for loading
        setTimeout(() => {
          if (!map.loaded()) {
            updateStatus('<strong>‚è±Ô∏è Map Loading Timeout</strong><br>Taking longer than expected...', 'error');
          }
        }, 15000);

      } catch (error) {
        console.error('Initialization failed:', error);
        updateStatus('<strong>‚ùå Initialization Failed:</strong><br>' + error.message, 'error');
      }
    }

    function setupMapFeatures() {
      try {
        // Only add navigation controls if they don't already exist
        const hasNavControls = map._controls.some(control => 
          control instanceof mapboxgl.NavigationControl
        );
        if (!hasNavControls) {
          map.addControl(new mapboxgl.NavigationControl());
        }
        
        // Remove existing directions control completely
        if (directionsControl) {
          try {
            map.removeControl(directionsControl);
            directionsControl = null;
          } catch (e) {
            console.log('Directions control already removed or not found');
          }
        }
        
        // Create a fresh directions control
        try {
          directionsControl = new MapboxDirections({
            accessToken: MAPBOX_TOKEN,
            unit: 'imperial',
            profile: 'mapbox/driving-traffic',
            alternatives: false,
            geometries: 'geojson',
            controls: { instructions: false },
            flyTo: false
          });
          
          map.addControl(directionsControl, 'top-left');
          
          // Listen for route events from directions control
          directionsControl.on('route', function(event) {
            if (event.route && event.route.length > 0) {
              analyzeDirectionsRoute(event.route[0]);
            }
          });
          
          directionsControl.on('clear', function() {
            clearRoute();
          });
          
          // Handle directions errors gracefully
          directionsControl.on('error', function(e) {
            console.warn('Directions error (non-critical):', e);
            // Don't show error for minor directions issues
          });
          
        } catch (directionsError) {
          console.error('Failed to add directions control:', directionsError);
          updateDiagnostics(`‚ö†Ô∏è Directions control failed to load: ${directionsError.message}`);
        }
        
        // Add obstacles with error checking
        if (typeof turf !== 'undefined') {
          try {
            const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
            
            // Remove existing obstacle layers/sources if they exist
            if (map.getLayer('obstacles-fill')) {
              map.removeLayer('obstacles-fill');
            }
            if (map.getSource('obstacles')) {
              map.removeSource('obstacles');
            }
            
            map.addSource('obstacles', {
              type: 'geojson',
              data: obstacle
            });

            map.addLayer({
              id: 'obstacles-fill',
              type: 'fill',
              source: 'obstacles',
              paint: {
                'fill-color': '#f03b20',
                'fill-opacity': 0.5
              }
            });
          } catch (obstacleError) {
            console.error('Failed to add obstacles:', obstacleError);
            updateDiagnostics(`‚ö†Ô∏è Obstacle layer failed: ${obstacleError.message}`);
          }
        } else {
          updateDiagnostics(`‚ö†Ô∏è Turf.js not available for obstacle analysis`);
        }

        // Setup route layer for our custom analysis
        try {
          // Remove existing route analysis layers/sources if they exist
          if (map.getLayer('route-analysis-layer')) {
            map.removeLayer('route-analysis-layer');
          }
          if (map.getSource('route-analysis')) {
            map.removeSource('route-analysis');
          }
          
          map.addSource('route-analysis', {
            type: 'geojson',
            data: { type: 'FeatureCollection', features: [] }
          });

          map.addLayer({
            id: 'route-analysis-layer',
            type: 'line',
            source: 'route-analysis',
            layout: { 'line-join': 'round', 'line-cap': 'round' },
            paint: { 'line-color': '#ff0000', 'line-width': 8, 'line-opacity': 0.8 }
          });
        } catch (routeLayerError) {
          console.error('Failed to add route analysis layer:', routeLayerError);
          updateDiagnostics(`‚ö†Ô∏è Route analysis layer failed: ${routeLayerError.message}`);
        }

        // Setup route customization (only once)
        setupRouteCustomization();
        
        console.log('‚úÖ Map features setup complete');
        
      } catch (error) {
        console.error('Error in setupMapFeatures:', error);
        updateDiagnostics(`‚ùå Feature setup error: ${error.message}`);
      }
    }

    async function populateStyleSelector() {
      const select = document.getElementById('styleSelector');
      
      // Since we can't access the Styles API with a public token,
      // we'll include your known custom styles manually
      updateDiagnostics('Loading available map styles...');
      
      // Clear existing options
      select.innerHTML = '';
      
      // Add default Mapbox styles first
      const defaultStyles = [
        { name: 'üìç Streets', value: 'mapbox://styles/mapbox/streets-v11' },
        { name: 'üå≤ Outdoors', value: 'mapbox://styles/mapbox/outdoors-v11' },
        { name: '‚òÄÔ∏è Light', value: 'mapbox://styles/mapbox/light-v10' },
        { name: 'üåô Dark', value: 'mapbox://styles/mapbox/dark-v10' },
        { name: 'üõ∞Ô∏è Satellite', value: 'mapbox://styles/mapbox/satellite-v9' },
        { name: 'üó∫Ô∏è Satellite Streets', value: 'mapbox://styles/mapbox/satellite-streets-v11' }
      ];
      
      // Your custom styles - Add all your style IDs here
      // To find these: Go to Mapbox Studio > Styles, and copy the style URLs
      const customStyles = [
        { name: 'Classic Standard', id: 'ckxnnmex53n1b14m07t6sum48' },
        { name: 'Classic Vintage', id: 'ckxnmjiti0rvm14pby8w9si99' },
        { name: 'Dark Digital', id: 'ckxov33jj3le314ueu15gl6yh' },
        { name: 'Dark Monochrome', id: 'ckxmhuc4k2gxm14s0eq1htzns' },
        { name: 'Dark Night Mode', id: 'ckxs1bfov2cay14mnx6nvrzxt' },
        { name: 'Light Engraved', id: 'ckwgtu6ly20cr15qiy9i2ftsz' },
        { name: 'Light High Contrast', id: 'ckxntkwjq4flv14ld7uisp5b1' },
        { name: 'Light Pencil Sketch', id: 'ckxouv50s02lw14r2jiyvnvxh' },
        { name: 'Pastel Blue', id: 'ckxtl08qj2gb215p8y2blzxur' },
        { name: 'Pastel Cool', id: 'ckxtkuk8l10zj14pk8irf7owt' },
        { name: 'Pastel Pink', id: 'ckxtl2a2s0yot14nw9pbn2733' },
        { name: 'Pastel Yellow', id: 'ckxtl35nk4hsb15mry8rwlg4l' },
        { name: 'Satellite Streets', id: 'ckxmjckme2if514s0v3xq4vxy' },
        { name: 'Topography Colorful', id: 'ckxrnuq691z6h14mnuy5jpk5c' },
        { name: 'Topography Globe', id: 'ckxnp39kb5eyw14oaan01mkp0' },
        { name: 'Topography Outdoor', id: 'ckxnkf6rs60r214uc0j42vbj4' },
        { name: 'Topography Subtle', id: 'ckxnqwyww0sri14p9skglgshs' },
        { name: 'Topography Vintage', id: 'ckxno9jbk3nn714s6vjah6fwb' },
        { name: 'Unique Colorful', id: 'ckxrrtfqk0oir15my0y9tpjvj' },
        { name: 'Unique Comic Book 1‚Äô, id: 'ckxovchyg4tfj14s6d7u559tj' },
        { name: 'Unique Comic Book 2', id: 'ckxov6vgm66g214o064dp3vda' },
        { name: 'Unique Dusty Western', id: 'ckxove5sy174l15mq6h82hwxk' },
        { name: 'Unique Picture Book', id: 'ckxoup98z4sv514m0q988ltie' },
        { name: 'Unique Treasure Map', id: 'ckxov1ris0n2415p4e9gn8oxu' },
        { name: 'Unique Woodcut', id: 'ckxous4km02k114m523qh0k9y' },
        // Add more of your custom styles here in this format:
        // { name: 'Your Style Name', id: 'your-style-id' },
        
        // If you have ~22 styles, you can add them all here
        // You can find the IDs by going to Mapbox Studio > Styles
        // and looking at the URL: https://studio.mapbox.com/styles/cb29/STYLE_ID_HERE/
      ];
      
      // Add separator
      const separatorOption = document.createElement('option');
      separatorOption.disabled = true;
      separatorOption.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Default Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
      select.appendChild(separatorOption);
      
      defaultStyles.forEach(style => {
        const option = document.createElement('option');
        option.value = style.value;
        option.textContent = style.name;
        select.appendChild(option);
      });
      
      // Add separator for custom styles
      const customSeparator = document.createElement('option');
      customSeparator.disabled = true;
      customSeparator.textContent = '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Your Custom Styles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ';
      select.appendChild(customSeparator);
      
      // Add your custom styles
      customStyles.forEach(style => {
        const option = document.createElement('option');
        option.value = `mapbox://styles/cb29/${style.id}`;
        option.textContent = `üé® ${style.name}`;
        select.appendChild(option);
      });
      
      // Try to test if the custom styles are accessible
      let accessibleStyles = 0;
      for (const style of customStyles) {
        try {
          // Test if we can access the style by trying to get its metadata
          const styleUrl = `https://api.mapbox.com/styles/v1/cb29/${style.id}?access_token=${MAPBOX_TOKEN}`;
          const response = await fetch(styleUrl, { method: 'HEAD' });
          if (response.ok) {
            accessibleStyles++;
          }
        } catch (error) {
          // Style might not be accessible, but that's okay
        }
      }
      
      updateDiagnostics(`‚úÖ Style selector loaded with ${defaultStyles.length + customStyles.length} styles`);
      if (accessibleStyles > 0) {
        updateDiagnostics(`‚úÖ ${accessibleStyles} custom styles are accessible`);
      }
      
      // Add instructions for adding more styles
      if (customStyles.length < 22) {
        updateDiagnostics(`‚ÑπÔ∏è To add your remaining styles, edit the customStyles array in the code`);
      }
      
      select.disabled = false;
      select.addEventListener('change', function() {
        if (this.value && !this.options[this.selectedIndex].disabled) {
          updateDiagnostics(`Switching to style: ${this.options[this.selectedIndex].textContent}`);
          
          // Store current route data before style change
          let currentRouteData = null;
          if (map.getSource('route-analysis')) {
            try {
              currentRouteData = map.getSource('route-analysis')._data;
            } catch (e) {
              // Ignore errors when getting route data
            }
          }
          
          // Properly remove the directions control before style change
          if (directionsControl) {
            try {
              map.removeControl(directionsControl);
              directionsControl = null;
            } catch (e) {
              console.log('Directions control removal handled');
            }
          }
          
          // Change the style
          map.setStyle(this.value);
          
          // Wait for style to load and then restore features
          map.once('style.load', function() {
            try {
              // Small delay to ensure style is fully loaded
              setTimeout(() => {
                setupMapFeatures();
                
                // Restore route data if it existed
                if (currentRouteData && currentRouteData.features && currentRouteData.features.length > 0) {
                  setTimeout(() => {
                    if (map.getSource('route-analysis')) {
                      map.getSource('route-analysis').setData(currentRouteData);
                    }
                  }, 200);
                }
                
                updateDiagnostics(`‚úÖ Style switched successfully`);
              }, 100);
              
            } catch (error) {
              console.error('Error setting up features after style change:', error);
              updateDiagnostics(`‚ö†Ô∏è Style loaded but some features may need refresh`);
            }
          });
          
          // Handle style load errors
          map.once('error', function(e) {
            console.error('Map error after style change:', e);
            updateDiagnostics(`‚ùå Error after style change: ${e.error ? e.error.message : 'Unknown error'}`);
          });
        }
      });
    }

    function analyzeDirectionsRoute(route) {
      // Display the route for analysis
      map.getSource('route-analysis').setData(route.geometry);
      
      // Check for obstacles using Turf.js
      const obstacle = turf.buffer(clearances, 0.25, { units: 'kilometers' });
      const clear = turf.booleanDisjoint(obstacle, route.geometry);
      
      const duration = Math.round(route.duration / 60);
      const distance = (route.distance / 1000).toFixed(1);
      
      if (clear) {
        // Safe route - make it green
        map.setPaintProperty('route-analysis-layer', 'line-color', '#00ff00');
        map.setPaintProperty('route-analysis-layer', 'line-width', 12);
        addReport('‚úÖ Safe Route Found!', `${duration} min, ${distance} km - avoids all obstacles`, true);
        updateStatus('<strong>‚úÖ Safe Route!</strong><br>' + duration + ' minutes, avoids all obstacles', 'success');
        
        // Apply custom color if user changed it
        const customColor = document.getElementById('routeColor').value;
        if (customColor !== '#ff0000') {
          map.setPaintProperty('route-analysis-layer', 'line-color', customColor);
        }
      } else {
        // Dangerous route - keep it red and add warning
        map.setPaintProperty('route-analysis-layer', 'line-color', '#ff0000');
        map.setPaintProperty('route-analysis-layer', 'line-width', 12);
        addReport('‚ö†Ô∏è Obstacle Warning', `${duration} min, ${distance} km - intersects clearance zones`, false);
        updateStatus('<strong>‚ö†Ô∏è Obstacle Warning!</strong><br>Route intersects low-clearance areas', 'error');
      }
      
      // Apply custom width
      const customWidth = document.getElementById('routeWidth').value;
      map.setPaintProperty('route-analysis-layer', 'line-width', parseInt(customWidth));
    }

    function setupRouteCustomization() {
      // Only set up event listeners once to prevent duplicates
      const colorInput = document.getElementById('routeColor');
      const widthInput = document.getElementById('routeWidth');
      
      // Remove existing event listeners to prevent duplicates
      const newColorInput = colorInput.cloneNode(true);
      const newWidthInput = widthInput.cloneNode(true);
      colorInput.parentNode.replaceChild(newColorInput, colorInput);
      widthInput.parentNode.replaceChild(newWidthInput, widthInput);
      
      // Route color customization
      newColorInput.addEventListener('change', function() {
        if (map.getLayer('route-analysis-layer')) {
          map.setPaintProperty('route-analysis-layer', 'line-color', this.value);
        }
      });

      // Route width customization
      newWidthInput.addEventListener('change', function() {
        if (map.getLayer('route-analysis-layer')) {
          map.setPaintProperty('route-analysis-layer', 'line-width', parseInt(this.value));
        }
      });
    }

    function addReport(title, details, isSuccess) {
      const reports = document.getElementById('reports');
      const card = document.createElement('div');
      card.className = 'card';
      
      const header = document.createElement('div');
      header.className = `card-header ${isSuccess ? 'route-found' : 'obstacle-found'}`;
      header.textContent = title;
      
      const body = document.createElement('div');
      body.className = 'card-details';
      body.textContent = details;
      
      card.appendChild(header);
      card.appendChild(body);
      reports.insertBefore(card, reports.firstChild);
    }

    function clearRoute() {
      if (map && map.getSource('route-analysis')) {
        map.getSource('route-analysis').setData({ type: 'FeatureCollection', features: [] });
      }
      
      document.getElementById('reports').innerHTML = '';
      updateStatus('<strong>üéØ Ready for New Route</strong><br>Use the search boxes or click on map', 'loading');
    }

    // Start diagnostics immediately
    window.addEventListener('load', function() {
      setTimeout(() => {
        runNetworkDiagnostics();
        testDirectMapbox();
      }, 1000);
    });

    console.log('üõ£Ô∏è Route Finder loaded, starting network diagnostics...');
  </script>
</body>
</html>
