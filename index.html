<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Map Route Export App</title>
  <link rel="stylesheet" href="https://unpkg.com/mapbox-gl@2.14.1/dist/mapbox-gl.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    .card {
      background: #fff;
      padding: 1em;
      margin: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    #export-controls {
      margin-top: 1em;
    }
    .form-group {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Export Panel -->
  <div class="card" id="export-panel">
    <h3>Export Map</h3>
    <div class="form-group">
      <label>Print Size:</label>
      <select id="printSize">
        <option value="16x20">16x20"</option>
        <option value="18x24">18x24"</option>
        <option value="A2">A2 (42x59.4cm)</option>
      </select>
    </div>
    <div class="form-group">
      <label>DPI:</label>
      <select id="dpi">
        <option value="300">300</option>
        <option value="150">150</option>
      </select>
    </div>
    <div class="form-group">
      <label>Include Bleed:</label>
      <input type="checkbox" id="includeBleed" checked />
      <input type="number" id="bleedSize" placeholder="inches" value="0.25" step="0.01" style="width: 80px;" />
    </div>
    <div class="form-group">
      <label>Format:</label>
      <select id="fileFormat">
        <option value="png">PNG</option>
        <option value="jpg">JPG</option>
      </select>
    </div>
    <div class="form-group">
      <label>File Name:</label>
      <input type="text" id="fileName" value="exported_map" />
    </div>
    <button onclick="RouteFinderApp.fileManager.exportMap()">Export</button>
  </div>

  <script src="https://unpkg.com/mapbox-gl@2.14.1/dist/mapbox-gl.js"></script>
  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/cb29/ckxnmjiti0rvm14pby8w9si99',
      center: [-122.447303, 37.753574],
      zoom: 12
    });

    const RouteFinderApp = {
      fileManager: {
        exportMap: function () {
          const printSize = document.getElementById("printSize").value;
          const dpi = parseInt(document.getElementById("dpi").value);
          const includeBleed = document.getElementById("includeBleed").checked;
          const bleedSize = parseFloat(document.getElementById("bleedSize").value);
          const format = document.getElementById("fileFormat").value;
          const fileName = document.getElementById("fileName").value;

          const sizes = {
            "16x20": [16, 20],
            "18x24": [18, 24],
            "A2": [16.54, 23.39]
          };
          let [w, h] = sizes[printSize] || [16, 20];
          if (includeBleed) {
            w += bleedSize * 2;
            h += bleedSize * 2;
          }
          const width = Math.round(w * dpi);
          const height = Math.round(h * dpi);

          const exportMap = new mapboxgl.Map({
            container: document.createElement("div"),
            style: map.getStyle(),
            center: map.getCenter(),
            zoom: map.getZoom(),
            interactive: false,
            preserveDrawingBuffer: true
          });

          exportMap.once("idle", () => {
            const canvas = exportMap.getCanvas();
            canvas.width = width;
            canvas.height = height;
            setTimeout(() => {
              const dataURL = canvas.toDataURL(`image/${format}`);
              const link = document.createElement("a");
              link.download = `${fileName}.${format}`;
              link.href = dataURL;
              link.click();
              exportMap.remove();
            }, 1000);
          });
        }
      }
    };
  </script>
</body>
</html>
