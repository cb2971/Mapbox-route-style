<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Map Export Tool</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.1/mapbox-gl-directions.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #nav {
      position: absolute;
      top: 0;
      left: 0;
      width: 300px;
      background: #fff;
      padding: 16px;
      z-index: 10;
      overflow-y: auto;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      max-height: 100vh;
    }
    .section {
      margin-bottom: 20px;
    }
    .section h3 {
      margin-top: 0;
      font-size: 1.1em;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    label { display: block; margin-bottom: 0.5em; }
    input, select { width: 100%; margin-top: 0.25em; padding: 0.25em; }
    button { margin-top: 1em; padding: 0.5em; width: 100%; }
    #export-controls { display: none; border-top: 1px solid #ccc; padding-top: 1em; }
    #export-map { width: 0; height: 0; position: absolute; top: -9999px; }
    #previewModal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 9999; display: none;
    }
    #previewModal img {
      max-width: 90%; max-height: 90%;
      border: 4px solid white;
    }
  </style>
</head>
<body>
<div id="map"></div>
<div id="nav">
  <div class="section">
    <h3>Map Style</h3>
    <label for="styleSelector">Select Map Style:
      <select id="styleSelector">
        <option value="mapbox://styles/mapbox/streets-v11">Streets</option>
        <option value="mapbox://styles/mapbox/outdoors-v11">Outdoors</option>
        <option value="mapbox://styles/mapbox/light-v10">Light</option>
        <option value="mapbox://styles/mapbox/dark-v10">Dark</option>
        <option value="mapbox://styles/mapbox/satellite-v9">Satellite</option>
        <option value="mapbox://styles/mapbox/satellite-streets-v11">Satellite Streets</option>
        <option value="mapbox://styles/cb29/ckxnmjiti0rvm14pby8w9si99">Custom Style</option>
      </select>
    </label>
  </div>
  <div class="section">
    <h3>Route Tools</h3>
    <label><input type="checkbox" id="toggleRoute" checked> Show Travel Route</label>
    <label><input type="checkbox" id="toggleRouteLayer" checked> Show All Routes</label>
    <button onclick="clearRoutes()">Clear All Routes</button>
  </div>
  <div class="section">
    <h3 style="cursor:pointer;" onclick="toggleExportControls()">Export Map ▼</h3>
    <div id="export-controls">
      <label>Print Size:
        <select id="printSize">
          <option value="16x20">16×20" (40.6×50.8cm)</option>
          <option value="18x24">18×24" (45.7×61cm)</option>
          <option value="A2">A2 (42×59.4cm)</option>
          <option value="custom">Custom Size</option>
        </select>
      </label>
      <div id="customSizeInputs" style="display:none">
        <label>Width (in): <input type="number" id="customWidth" value="16" /></label>
        <label>Height (in): <input type="number" id="customHeight" value="20" /></label>
      </div>
      <label>DPI:
        <select id="dpi">
          <option value="300">300</option>
          <option value="150">150</option>
        </select>
      </label>
      <label>Orientation:
        <select id="orientation">
          <option value="portrait">Portrait</option>
          <option value="landscape">Landscape</option>
        </select>
      </label>
      <label><input type="checkbox" id="includeBleed" checked> Include bleed</label>
      <label>Bleed amount (in): <input type="number" id="bleedMargin" step="0.01" value="0.25" /></label>
      <label>File name: <input type="text" id="fileName" value="exported_map" /></label>
      <label>Format:
        <select id="fileFormat">
          <option value="png">PNG</option>
          <option value="jpeg">JPG</option>
        </select>
      </label>
      <button onclick="exportMapImage()">Export Map</button>
    </div>
  </div>
</div>
<div id="export-map"></div>
<div id="previewModal" onclick="this.style.display='none'"><img id="previewImg" src="" /></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiY2IyOSIsImEiOiJja3E4OHo3anowZGx1Mm9tcXF3ZmhyaWtwIn0.IQ5rY622AU9GOETrqa9NBw';
const map = new mapboxgl.Map({
  container: 'map',
  style: document.getElementById('styleSelector').value,
  center: [-122.447303, 37.753574],
  zoom: 10
});

const directions = new MapboxDirections({
  accessToken: mapboxgl.accessToken,
  unit: 'imperial',
  profile: 'mapbox/driving',
  controls: {
    inputs: true,
    instructions: false
  }
});
map.addControl(directions, 'top-left');

document.getElementById("toggleRoute").addEventListener("change", e => {
  directions.container.style.display = e.target.checked ? "block" : "none";
});

document.getElementById("styleSelector").addEventListener("change", e => {
  map.setStyle(e.target.value);
});

document.getElementById("printSize").addEventListener("change", function() {
  document.getElementById("customSizeInputs").style.display = this.value === "custom" ? "block" : "none";
});

function toggleExportControls() {
  const panel = document.getElementById("export-controls");
  panel.style.display = panel.style.display === "none" ? "block" : "none";
}

function inchesToPixels(inches, dpi) {
  return Math.round(inches * dpi);
}

function getExportDimensions(size, dpi, includeBleed, orientation) {
  const sizes = {
    "16x20": [16, 20], "18x24": [18, 24], "A2": [16.54, 23.39]
  };
  let [w, h] = size === "custom"
    ? [parseFloat(document.getElementById("customWidth").value), parseFloat(document.getElementById("customHeight").value)]
    : sizes[size] || [16, 20];
  if (orientation === "landscape") [w, h] = [h, w];
  if (includeBleed) {
    const bleed = parseFloat(document.getElementById("bleedMargin").value) || 0;
    w += bleed * 2; h += bleed * 2;
  }
  return [inchesToPixels(w, dpi), inchesToPixels(h, dpi)];
}

function clearRoutes() {
  directions.setOrigin(null);
  directions.setDestination(null);
  directions.removeRoutes();
}

function exportMapImage() {
  const style = document.getElementById("styleSelector").value;
  const size = document.getElementById("printSize").value;
  const dpi = parseInt(document.getElementById("dpi").value);
  const includeBleed = document.getElementById("includeBleed").checked;
  const orientation = document.getElementById("orientation").value;
  const fileName = document.getElementById("fileName").value || "exported_map";
  const format = document.getElementById("fileFormat").value;
  const [width, height] = getExportDimensions(size, dpi, includeBleed, orientation);

  const exportContainer = document.getElementById("export-map");
  exportContainer.style.width = width + "px";
  exportContainer.style.height = height + "px";

  const exportMap = new mapboxgl.Map({
    container: "export-map",
    style: style,
    center: map.getCenter(),
    zoom: map.getZoom(),
    interactive: false,
    preserveDrawingBuffer: true
  });

  exportMap.once("idle", () => {
    try {
      const dataURL = exportMap.getCanvas().toDataURL("image/" + format);
      document.getElementById("previewImg").src = dataURL;
      document.getElementById("previewModal").style.display = "flex";
      const link = document.createElement("a");
      link.download = fileName + "." + format;
      link.href = dataURL;
      link.click();
      exportMap.remove();
    } catch (e) {
      alert("❌ Export failed. Try a smaller size or DPI.");
      console.error(e);
      exportMap.remove();
    }
  });
}
</script>
</body>
</html>
